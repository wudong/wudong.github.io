<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="This is a demo site for Nikola.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Warren Liu (old posts, page 1) | Warren Liu</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://example.com/index-1.html">
<link rel="prev" href="index-2.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://example.com/">

                <span id="blog-title">Warren Liu</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/java-interview-questions/" class="u-url">Java Interview Questions</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/java-interview-questions/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Java Programming Interview Exposed</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Writing core algorithm</h3>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">How would you implement a bubble sort algorithm?</h3>
<div class="outline-text-3" id="text-1-2">
<p>
The <b>bubble sort</b> is extremely simple to describe and implements.
</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">bubblesort</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">numbers</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">numbersSwitched</span><span class="o">;</span>
    <span class="k">do</span> <span class="o">{</span>
	<span class="n">numbersSwitched</span><span class="o">=</span><span class="kc">false</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">numbers</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">]&lt;</span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]){</span>
		<span class="n">swap</span><span class="o">(</span><span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">],</span> <span class="n">numbers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
		<span class="n">numbersSwitched</span><span class="o">=</span><span class="kc">true</span><span class="o">;</span>
	    <span class="o">}</span>
	<span class="o">}</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">numbersSwitched</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>




<p>
The worse case, when you want to sort a list that is already sorted in
reverse order, the performance is of \(O(n^2)\): <i>for each iteration, you
are only switching one elements</i>. The best case is when a list is
already sorted, which has performance of \(O(n)\).
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">How would you implement a insert sort algorithm?</h3>
<div class="outline-text-3" id="text-1-3">
<p>
The <b>insert sort</b> is another simple algorithm to describe:
</p>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">insertSort</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numbers</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">sortedList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>

<span class="nl">    originalList:</span> <span class="k">for</span> <span class="o">(</span><span class="n">Integer</span> <span class="n">number</span><span class="o">:</span> <span class="n">numbers</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">sortedList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++){</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="n">sortedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span>
		<span class="n">sortedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">number</span><span class="o">);</span>
		<span class="k">continue</span> <span class="n">originalList</span><span class="o">;</span>
	    <span class="o">}</span>
	<span class="o">}</span>
	<span class="n">sortedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sortedList</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">number</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>
The worst-case performance is still \(O(n^2)\).
</p>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">How would you implement the quicksort algorithm?</h3>
<div class="outline-text-3" id="text-1-4">
<p>
The performance is much more efficient than the bubble sort and insert
sort with an average performance of \(O(n\log(n))\). The worst case is
still \(O(n^2)\). The choice of pivot can make a difference.
</p>

<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">quicksort</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numbers</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numbers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">){</span>
	<span class="k">return</span> <span class="n">numbers</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">Integer</span> <span class="n">pivot</span> <span class="o">=</span> <span class="n">numbers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">lower</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">higher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span> <span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">numbers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">numbers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">lower</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">numbers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
	<span class="o">}</span><span class="k">else</span><span class="o">{</span>
	    <span class="n">higher</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">numbers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
	<span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">sorted</span> <span class="o">=</span> <span class="n">quicksort</span><span class="o">(</span><span class="n">lower</span><span class="o">);</span>
    <span class="n">sorted</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pivot</span><span class="o">);</span>
    <span class="n">sorted</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">quicksort</span><span class="o">(</span><span class="n">higher</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">sroted</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>
It is worth noting that each division of the list and the subsequent
recursive call is <b>independent</b> of any other sorting necessary, and
could be performed <b>in parallel</b>.
</p>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">How would you implement the merge sort algorithm?</h3>
<div class="outline-text-3" id="text-1-5">
<p>
This is another divide-and-conquer algorithm: split the list into two,
sort each sublist, and then merge the two list together.
</p>

<p>
The main code is <b>merging the two lists efficiently</b>.
</p>

<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">merge</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">,</span>
				  <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">right</span>
    <span class="o">){</span>
    <span class="kt">int</span> <span class="n">leftPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">rightPtr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">merged</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">left</span><span class="o">.</span><span class="na">size</span><span class="o">()+</span><span class="n">right</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">leftPtr</span> <span class="o">&lt;</span> <span class="n">left</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">rightPtr</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">.</span><span class="na">size</span><span class="o">()){</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">leftPtr</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">rightPtr</span><span class="o">)){</span>
	    <span class="n">merged</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">leftPtr</span><span class="o">));</span>
	    <span class="n">leftPtr</span><span class="o">++;</span>
	<span class="o">}</span><span class="k">else</span><span class="o">{</span>
	    <span class="n">merged</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">rightPtr</span><span class="o">));</span>
	    <span class="n">rightPtr</span><span class="o">++;</span>
	<span class="o">}</span>
    <span class="o">}</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">leftPtr</span> <span class="o">&lt;</span> <span class="n">left</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">){</span>
	<span class="n">merged</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">leftPtr</span><span class="o">));</span>
	<span class="n">leftPtr</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="k">while</span> <span class="o">(</span><span class="n">rightPtr</span> <span class="o">&lt;</span> <span class="n">right</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">){</span>
	<span class="n">merged</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">right</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">rightPtr</span><span class="o">));</span>
	<span class="n">rightPtr</span><span class="o">++;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">mergesort</span><span class="o">(</span><span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">values</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">){</span>
	<span class="k">return</span> <span class="n">values</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">leftHalf</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">values</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">/</span><span class="mi">2</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">leftHalf</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="na">size</span><span class="o">()/</span><span class="mi">2</span><span class="o">,</span> <span class="n">values</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">merge</span><span class="o">(</span><span class="n">mergesort</span><span class="o">(</span><span class="n">leftHalf</span><span class="o">),</span> <span class="n">mergesort</span><span class="o">(</span><span class="n">rightHalf</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>

<p>
Again, merge sort has a performance of \(O(n\log(n)\). Each merge
operation is \(O(n)\), and each recursive call works on only half of the
given list.
</p>
</div>
</div>

<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6">Data Structure</h3>
<div class="outline-text-3" id="text-1-6">
</div>
<div id="outline-container-sec-1-6-1" class="outline-4">
<h4 id="sec-1-6-1">Some notable <b>Collections</b> methods</h4>
<div class="outline-text-4" id="text-1-6-1">
<dl class="org-dl">
<dt> <code>sort, binarySearch</code> </dt>
<dd>with <b>Comparable</b> and <b>Comparator</b>
</dd>
<dt> <code>max, min</code> </dt>
<dd>with <b>Comparable</b> and <b>Comparator</b>
</dd>
<dt> <code>void rotate(List list, int distance)</code> </dt>
<dd>Rotates the elements in the
sepcified list by the specified distance. After calling this
method, the element at inde \(i\) will be the element previously at
index \((i - distance) mod list.size()\)
<ul class="org-ul">
<li>Can be usefully be applied to a sublist: <br><code>Collections.rotate(list.subList(j, k+1), -1);</code>
</li>
</ul>
</dd>
<dt> <code>void shuffle(List list, Random rnd)</code> </dt>
<dd>randomly permute the
specified list.
</dd>
<dt> (no term) </dt>
<dd>
<code>void reverse(List&lt;?&gt; list)</code>
</dd>
<dt> <code>&lt;T&gt; Comparator&lt;T&gt; reverseOrder(Comparator&lt;T&gt; cmp)</code> </dt>
<dd>returns a
comparator that imposes the reverse ordering of the specified
comparator.
</dd>
<dt> <code>int frequency(Collection c, Object o)</code> </dt>
<dd>return the number of
elements in the specified collection equal to the specified
object.
</dd>
<dt> <code>boolean disjoint(Collection c1, Collection c2)</code> </dt>
<dd>return true if
two specified collections have no elements in common.
</dd>
<dt> <code>List&lt;T&gt; nCopies(int n, T o)</code> </dt>
<dd>returns an <b>immutable</b> list
consisting of \(n\) copies of the specified object.
<ul class="org-ul">
<li>The newly allocated data object is tiny, containing a single
reference to the data object.
</li>
</ul>
</dd>
<dt> <code>singleton(T o)</code>  </dt>
<dd>return an <b>immutable</b> set containing only the
specified object.
<dl class="org-dl">
<dt> <code>singletonList(T o)</code> </dt>
<dd>an immutable list.
</dd>
<dt> <code>singletonMap&lt;K key, V value&gt;</code> </dt>
<dd>returns an <b>immutable</b> map that
only maps the specified key to the specified value.
</dd>
</dl>
</dd>
<dt> (no term) </dt>
<dd>Wrapper implementations
<ul class="org-ul">
<li>
<code>unmodifiableXXX</code>
</li>
<li>
<code>synchronizedXXX</code>
</li>
<li id="&lt;code&gt;checkedXXX(Collection&lt;T&gt; c, Class&lt;T&gt; type)&lt;/code&gt;">returns
a dynamically typesafe view of the specified collection. Any
attemp to insert an element of the wrong type will result in an
immediate ClassCastException.
<ul class="org-ul">
<li>This can prevent unchecked cast.
</li>
<li>
<code>checkedList</code>
</li>
<li>
<code>checkedSet</code>, <code>checkedSortedSet</code>
</li>
<li>
<code>checkedMap</code>, <code>checkedSortedMap</code>
</li>
</ul>
</li>
</ul>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-6-2" class="outline-4">
<h4 id="sec-1-6-2">Arrays</h4>
<div class="outline-text-4" id="text-1-6-2">
<dl class="org-dl">
<dt> <code>deepEquals(Object[] a1, Object[] a2), deepHashCode(), deepToString()</code> </dt>
<dd>supporting
nested sub-arrays.
</dd>
<dt> <code>fill</code> </dt>
<dd>assigns the value to the specified range of the specified array.
</dd>
<dt> <code>parallelPrefix(double[] array, DoubleBinaryOperator op)</code> </dt>
<dd>Cumulates,
in parallel, each element of the given array in place, using the
supplied function.
</dd>
<dt> <code>sort(T[] array, int fromIndex, int toIndex)</code> </dt>
<dd>support sosring in a range.
</dd>
<dt> <code>stream(T[] array, int startInclusive, int endExclusive)</code> </dt>
<dd>convert
a stream with the array as its source, also support range.
</dd>
<dt> (no term) </dt>
<dd>
<b>ArrayList</b>, or <b>ArrayDeque</b> should be preferable to <b>LinkedList</b> for
queues/dequeus due to a limited amount of garbage it generates.
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-6-3" class="outline-4">
<h4 id="sec-1-6-3">List</h4>
<div class="outline-text-4" id="text-1-6-3">
<ul class="org-ul">
<li>The usage of <code>subList</code> on the <code>List</code> interface:
<ul class="org-ul">
<li>The <b>List</b> interface now have a <b>subList(int fromIndex, int
toIndex)</b> function, to return a view of the portion of the list,
inclusive <code>fromIndex</code>, and exclusive <code>toIndex</code>.
</li>
<li>The returned list is backed by this list, so non-structural
changes in the returned list are reflected in this list, and
vice-versa.
</li>
<li>The method eliminates the need for explicit range operations. Any
operation that expects a list can be used as a range operation by
passing a subList view. For example, the following idiom removes a
range of element from a list:
<div class="highlight"><pre><span></span><span class="n">list</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span>
</pre></div>
</li>
<li>Some list implementations have restrictions on the elements that
they may contain. For example, some implementations prohibit
<code>null</code> elements, and some have restrictions on the types of their
elements. Attempting to add an ineligible element throws an
unchecked exception, typically <b>NullPointerException</b> or
<b>ClassCastException</b>.
</li>
<li>
<b>toArray()</b> will return a new array.
</li>
<li>
<b>toArray(T[] a)</b> will also return a <b>new array</b>, <i>not the one
specified</i>, if the size of <code>a</code> is smaller than the List; it
otherwise return <code>a</code>, with the remaining of <code>a</code> set to <code>null</code> if <code>a</code>
contains more elements thant the List.
</li>
<li>
<b>retainAll(Collection&lt;?&gt; c)</b> will retains only the elements in
this list that care contained in the specified collection.
</li>
</ul>
</li>
<li>ArrayList
<ul class="org-ul">
<li>ArrayList allows <code>null</code> elements.
</li>
<li>Be aware that the array size reallocation in ArrayList is
<b>one-way</b>; it doesn't shrink if elements are removed from it. If
you have a list that oscillates between many and a few elements,
<b>ArrayList</b> might not be the best implementation for it.
</li>
<li>Increase the capacity of an <b>ArrayList</b> before adding a large
number of elements using <b>ensureCapacity()</b> operation. This <i>could
reduce the amount of incremental reallocation</i>.
</li>
</ul>
</li>
<li>LinkedList
<ul class="org-ul">
<li>It is a <b>doubly-linked</b> list implementation of the <code>List</code> and
<code>Deque</code> interface.
</li>
<li>Operations that index into the list will traverse the list from
<i>the beginning or the end</i>, whichever is closer to the specified
index.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-6-4" class="outline-4">
<h4 id="sec-1-6-4">Queue and Deque</h4>
<div class="outline-text-4" id="text-1-6-4">
<ul class="org-ul">
<li>interface <b>Queue</b>
<ul class="org-ul">
<li>Queue implementations generally do not allow insertion of <code>null</code>
elements, although some implementations, such as <b>LinkedList</b>, do
not prohibit insertion of <code>null</code>.
</li>
<li>Even in the implementations that permit it, <code>null</code> should not be
inserted into a <b>Queue</b>, as <code>null</code> is also used as a <span class="underline">special return</span>
value by the <code>poll</code> method to <i>indicate that the queue contains no
elements</i>.
</li>
<li>Queues provide additional insertion, extraction, and
inspection operations; and each of these methods exists in two
forms: <b>throw exception</b> or <b>return special value</b> when the
operation fails.
</li>
<li>The latter form of the insert operation is designed specifically
for use with <b>capacity-restricted</b> Queue implementations; in most
implementations, insert operations cannot fail.
</li>
<li>The two set of methods:
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">Operation</th>
<th scope="col" class="left">Throws Exception</th>
<th scope="col" class="left">Return special value</th>
</tr></thead>
<tbody>
<tr>
<td class="left">Insert</td>
<td class="left">add(e)</td>
<td class="left">offer(e)</td>
</tr>
<tr>
<td class="left">Remove</td>
<td class="left">remove()</td>
<td class="left">poll()</td>
</tr>
<tr>
<td class="left">Examine</td>
<td class="left">element()</td>
<td class="left">peek()</td>
</tr>
</tbody>
</table>
</li>
<li>Order for Queue is normally <b>FIFO</b>, except for <b>priority
queues</b>, which order according to a supplied comparator, and
<b>LIFO</b> queue(stack).
</li>
</ul>
</li>
<li>interface <b>Deque</b>
<ul class="org-ul">
<li>Pronounced "deck" is an extension of Queue, and allows additon and
removal from either end of the data structure.
</li>
<li>For each methods defined in <code>Queue</code>, <code>Deque</code> defines corresponding
<b>First</b>, and <b>Last</b> methods like: <code>addFirst()</code>, <code>addLast()</code>,
<code>offerFirst()</code> and <code>offerLast()</code>.
</li>
<li>
<b>descendingIterator()</b>  from the <code>Deque</code> interface can be used to
iterate in reverse sequential order.
</li>
<li>Deques can also be used as <b>LIFO (Last-In-First-Out) stacks</b>. This
interface should be used <b>in preference to</b> the <b>legacy</b> <code>Stack</code>
class:
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">Stack Method</th>
<th scope="col" class="left">Equivalent Deque Method</th>
</tr></thead>
<tbody>
<tr>
<td class="left">push(e)</td>
<td class="left">addFirst(e)</td>
</tr>
<tr>
<td class="left">pop()</td>
<td class="left">removeFirst(e)</td>
</tr>
<tr>
<td class="left">peed()</td>
<td class="left">peekFirst()</td>
</tr>
</tbody>
</table>
</li>
<li>
<code>removeFirstOccurrence(e)</code> and <code>removeLastOccurrence(e)</code> is
available on <b>LinkedList</b>.
</li>
<li>Apart from <b>LinkedList</b>, <b>ArrayDeque</b> is a resizable-array
implementation of the <code>Deque</code> interface.
</li>
</ul>
</li>
<li>class <b>PriorityQueue</b>
<ul class="org-ul">
<li>An unbounded priority queue based on a <b>priority heap</b>.
</li>
<li>A priority queue does not permit <code>null</code>.
</li>
<li>A priority queue is <b>unbounded</b>, but has an <i>internal capacity</i>
governing the size of an array used to store the elements on the
queue.
</li>
<li>The <b>Iterator</b> returned from  <code>iterator()</code> is <b>not</b> gaurantee to
traverse the elements in any particular order. If ordered
traversal is needed, could use : <code>Arrays.sort(pq.toArray())</code>.
</li>
<li>This class is not threadsafe, <b>PriorityBlockingQueue</b> is.
</li>
<li>Heap based priority queue provides \(O(\log(n))\) for enqueing
dequeing methods; linear time for <code>remove()</code> and <code>contains()</code> methods
and constant time for the retrieval methods.
</li>
</ul>
</li>
<li>interface <b>BlockingQueue</b>
<ul class="org-ul">
<li>A <b>Queue</b> that additionally supports operations that <b>wait</b> for the
queue to become non-empty when retriving an element, and wait for
space to become available in the queue when storing an element.
</li>
<li>BlockingQueue methods come in four forms:
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">Operation</th>
<th scope="col" class="left">Throw Exception</th>
<th scope="col" class="left">Special Value</th>
<th scope="col" class="left">Blocks</th>
<th scope="col" class="left">Times out</th>
</tr></thead>
<tbody>
<tr>
<td class="left">Insert</td>
<td class="left">add(e)</td>
<td class="left">offer(e)</td>
<td class="left">put(e)</td>
<td class="left">offer(e, time, unit)</td>
</tr>
<tr>
<td class="left">Remove</td>
<td class="left">remove()</td>
<td class="left">poll()</td>
<td class="left">take()</td>
<td class="left">poll(time, unit)</td>
</tr>
<tr>
<td class="left">Examine</td>
<td class="left">element()</td>
<td class="left">peek()</td>
<td class="left">n/a</td>
<td class="left">n/a</td>
</tr>
</tbody>
</table>
</li>
<li>A blockingQueue does not accept null element.
</li>
<li>BlockingQueue implementations are designed to be used primarily
for <b>producer-consumer</b> queues, but additionally support the
<b>Collection</b> interface. However, such operations are in general <b>not</b>
<i>performed very efficiently</i>.
</li>
<li>
<b>drainTo(Collection c)</b> removes all available elements from this
queue and adds them to the given collection. This operation may be
more efficient than repeatdly polling thes queue.
</li>
<li>BlockingQueue implementations are thread. However, the <b>bulk</b>
Collection operations <code>addAll</code>, <code>containsAll</code>, <code>retainAll</code> and <code>removeAll</code>
are <b>not</b> necessarily <i>performed atomically</i> unless specified
otherwise in an implementation.
</li>
<li>
<b>Memory consistency effects</b>: As with other concurrent collections,
actions in a thread prior to <b>placing an object</b> into a
BlockingQueue <b>happen-before</b> actions subsequent to the <b>access</b> or
<b>removal</b> of that element from the BlockingQueue in another thread.
</li>
<li>
<b>LinkedBlockingQueue</b> is an optionally-bounded blocking queue. The
optional capacity serves as a way to prevent excessive queue
expansion, which default to <code>Integer.MAX_VALUE</code>.
</li>
<li>
<b>ArrayBlockingQueue</b> is a bounded blocking queue backed by an
array. The capacity cannot be changed once created.
<ul class="org-ul">
<li>This class supports an optional <b>fairness policy</b> for <b>ordering</b>
waiting producer and consumer threads. <i>By default, the ordering
is not guaranteed</i>. When setting, the access granted in <b>FIFO</b> order.
</li>
<li>Fairness generally decreases <i>throughput</i> but reduces
<i>variability</i> and avoids <i>starvation</i>.
</li>
</ul>
</li>
<li>
<b>SynchronousQueue</b> is a blocking queue in which each insert
operation must <b>wait for</b> a corresponding remove operation by
another thread, and vice versa.
<ul class="org-ul">
<li>A SynchronousQueue doesn't have any internal capacity, not even
a capacity of one.
</li>
<li>Cannot peek because element is only present when you try to
remove it; you cannot insert an element (using any method)
unless another thread is trying to remove it.
</li>
<li>its <code>isEmpty()</code> will always return <code>true</code>.
</li>
<li>Synchronous queue are similar to <b>rendezvous channels</b> used in
<b>CSP</b> and <b>Ada</b>.
</li>
<li>They are suited for <b>handoff designs</b>, in which an object running
in one thread must <i>sync up</i> with an object running in another
thread in order to <span class="underline">hand it some information, event, or task</span>.
</li>
</ul>
</li>
</ul>
</li>
<li>interface <b>TransferQueue</b> extends <b>BlockingQueue</b>
<ul class="org-ul">
<li>A <b>BlockingQueue</b> in which producers may wait for consumer to
receive elements.
</li>
<li>A <b>TransferQueue</b> may be useful for example in message passing
applications in which producers sometimes (using method
<b>transfer(E)</b>) await receipt of elements by consumers invoking take
or poll, while at other times enqueue elements (via method put)
without waiting for receipt.
</li>
<li>
<b>tryTransfer</b> can be used for Non-blocking and time-out for way.
</li>
<li>A <b>TransferQueue</b> can also be quired, with <b>hasWaitingComsumer()</b>.
</li>
<li>class <b>LinkedTransferQueue</b> implements this interface.
<ul class="org-ul">
<li>
<i>the size method is <b>NOT</b> a constant-time operation</i>: Because of
the asynchronous nature of these queues, determining the current
number of elements requires a traversal of the elements, and so
may report inaccurate results if this collection is modified
during traversal.
</li>
<li>bulk operations are <b>not</b> guaranteed to be performed atomically.
</li>
</ul>
</li>
<li>
<b>TransferQueue</b> is more generic and useful than
<b>SynchronousQueue</b>, allowing you to flexibly decide whether to use
normal BlockingQueue semantics or a guaranteed hand-off.
<ul class="org-ul">
<li>Much better performance than <b>SynchronousQueue</b>.
</li>
</ul>
</li>
</ul>
</li>
<li>class DelayQueue&lt;E extends Delayed&gt; implements <b>BlockingQueue</b>
<ul class="org-ul">
<li>An unbounded blocking queue of Delayed elements, in which an
element can only be taken when its delay has expired.
</li>
<li>The head of the queue is the Delayed element whose delay expired
furthest in the past.
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1-6-5" class="outline-4">
<h4 id="sec-1-6-5">Tree</h4>
<div class="outline-text-4" id="text-1-6-5">
<ul class="org-ul">
<li>Search with <b>binary search tree</b>:
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">search</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">toFind</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">toFind</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">)){</span>
	<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">toFind</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">value</span><span class="o">)&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">left</span> <span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">left</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">toFind</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">right</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">right</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">toFind</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Inserting value into a binary search tree:
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="kd">final</span> <span class="n">E</span> <span class="n">toInsert</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">toInsert</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeNode</span><span class="o">(</span><span class="n">toInsert</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span><span class="k">else</span> <span class="o">{</span>
	    <span class="n">left</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">toInsert</span><span class="o">);</span>
	<span class="o">}</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">right</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">right</span><span class="o">=</span> <span class="k">new</span> <span class="n">TreeNode</span><span class="o">(</span><span class="n">toInsert</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
	<span class="o">}</span><span class="k">else</span> <span class="o">{</span>
	    <span class="n">right</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">toInsert</span><span class="o">);</span>
	<span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>
Inserting in this manner may produce an <b>unbalanced tree</b>.
</p>
</li>
<li>Removing from a binary search tree:
<ol class="org-ol">
<li>Search for the node;
</li>
<li>If the node have no child, just remove it;
</li>
<li>If the node have only one child, remove the node, and link the
node's parent and child.
</li>
<li>If the node have two children:
<ol class="org-ol">
<li>Find a minimu value in the right subtree (or maximum value
in the left three);
</li>
<li>Replace the value of the node to be removed with found minimum;
</li>
<li>Remove the minimum from its right tree; notice that the
minimum has no left child, therefore, its removal may result
in first or second cases only.
</li>
</ol>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">,</span> <span class="n">BSTNode</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
	    <span class="k">return</span> <span class="n">left</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
	<span class="k">else</span>
	    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">right</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
	    <span class="k">return</span> <span class="n">right</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
	<span class="k">else</span>
	    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	    <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="na">minValue</span><span class="o">();</span>
	    <span class="n">right</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">left</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">parent</span><span class="o">.</span><span class="na">left</span> <span class="o">=</span> <span class="o">(</span><span class="n">left</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">left</span> <span class="o">:</span> <span class="n">right</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">right</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
	    <span class="n">parent</span><span class="o">.</span><span class="na">right</span> <span class="o">=</span> <span class="o">(</span><span class="n">left</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">left</span> <span class="o">:</span> <span class="n">right</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">minValue</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">left</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
	<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="k">else</span>
	<span class="k">return</span> <span class="n">left</span><span class="o">.</span><span class="na">minValue</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</li>
<li>A specific implementation of binary tree is called <b><a href="http://www.geeksforgeeks.org/avl-tree-set-1-insertion/">AVL Tree</a></b>
(self-balancing) enforces that, for any node, the <i>difference in
depth for each child is at most one</i>.
<ul class="org-ul">
<li>After each insertion or deletion of a node, the tree checks if
it is still balanced, and subsequently <b>rotates</b> the nodes of
values where the property of the <b>AVL Tree</b> doesn't not hold.
</li>
</ul>
</li>
<li>
<b><a href="http://www.geeksforgeeks.org/red-black-tree-set-1-introduction-2/">Red-Black Tree</a></b> is another self-balancing binary search tree with
one extra attribute for each node: <b>the colour</b>, being either red
or black:
<ul class="org-ul">
<li>Properties:
<ul class="org-ul">
<li>Root of the tree is always black.
</li>
<li>There are no two adjacent red nodes (A red node cannot have a
red parent or red child)
</li>
<li>Every path from <i>root to a NULL</i> node has same number of black
node.
</li>
</ul>
</li>
<li>The height of a Red-Black Tree is always \(O(\log(n))\), i.e. it is a
balanced tree.
</li>
</ul>
</li>
<li>Comparison of AVL Tree and Red-Black Tree:
<ul class="org-ul">
<li>AVL Tree is more balanced - better for search
</li>
<li>AVL Tree's deletion/insertion may involved more
roations. Red-Black tree is better for insert/deletion.
</li>
</ul>
</li>
<li>When a tree is balanced, search/insert/delete has performance of
\(O(\log(n))\).
</li>
<li>Bineary trees can be used for <b>Binary Heap</b>, which is a balanced
tree with the property that children are <b>greater than</b> their parent.
<ul class="org-ul">
<li>The heat property defines that the smallest element in the tree is
at the root. Heaps are especially useful for priority queues, or
any time you require quick access to the smallest element of a collection.
</li>
<li>A heap is not a sorted structure and can be regarded as
partially ordered.
</li>
<li>
<b>Insert</b>: the new element is initially appended to the right
most leaf node. The heap property is repaired by comparing the
added element with its parent and moving the added element up a
level by swapping with parent. It is repeated until the parent
is smaller or equal to the element. Performance is \((\log(n))\).
</li>
<li>
<b>DeleteMin</b>: Remove the root and replace it the right most
leaf. Then compare with its <b>smaller</b> child, and swapping until the
heap property is satisfied. Performance is \((\log(n))\).
</li>
<li>
<b>HeapSort</b>: build a heap and turn it into a sorted list by
calling <b>deleteMin</b> repeatly. It has performance of \((n\log(n))\).
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-6-6" class="outline-4">
<h4 id="sec-1-6-6">Set</h4>
<div class="outline-text-4" id="text-1-6-6">
<p>
For each of the Map implementation visited ealier, there is an
equvialent Set implementation:
</p>
<dl class="org-dl">
<dt> HashSet </dt>
<dd>implemented based on HashMap with dummy values (same
Object is used for every value).
</dd>
<dt> TreeSet </dt>
<dd>based on a TreeMap instance.
</dd>
<dt> (no term) </dt>
<dd>LinkedHashSet:: based on a LinkedHashMap instance.
</dd>
<dt> (no term) </dt>
<dd>
<b>SortedSet</b> and <b>NavigableSet</b> implemented by <b>TreeSet</b>.
</dd>
<dt> (no term) </dt>
<dd>
<b>Set &lt;E&gt; Collections.newSetFromMap(Map&lt;E, Boolean&gt; map)</b> returns a
set backed by the specified map. The resulting set displays the same
ordering, concurrency, and performance characterstics as the backing
map.
<ul class="org-ul">
<li>Useful to construct Set that doesn't have corresponding Set
implementation of a Map, like <b>WeakHashSet</b>, or
<b>ConcurrentHashMap</b>.
</li>
</ul>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-6-7" class="outline-4">
<h4 id="sec-1-6-7">Map</h4>
<div class="outline-text-4" id="text-1-6-7">
<ul class="org-ul">
<li>HashMap
<ul class="org-ul">
<li>The implementation permits <code>null</code> values and <code>null</code> key.
</li>
<li>An instance of HashMap has two parameters that affect its
performance: <b>initial capacity</b> and <b>load factor</b>. The capacity is
the <i>number of buckets</i> in the hash table. The load factor is a
measure of how full the hash table is allowed to get before its
capacity is automatically increased.
</li>
<li>When the number of entries in the hash table
<code>loadFactor*currentCapacity</code>, the hash table is <b>rehashed</b> so that
the hash table has approximately <b>twice</b> the number of buckets.
</li>
<li>When construct a new HashMap, a <b>load factor</b> between [0, 1] can
be specified: <code>public HashMap(int initialCapacity, float
    loadFactory)</code>. The default load factor is 0.75.
</li>
<li>If the initial capacity is greater than the maximum number of
entries divided by the load factor, no rehash operations will ever
occur.
</li>
<li>If many mappings are to be stored in a HashMap instance, creating
it with a sufficiently large capacity will allow the mappings to
be stored more efficiently than letting it perform automatic
rehashing as needed to grow the table.
</li>
<li>
<b>keySet()</b>, <b>values()</b> and <b>entrySet()</b> all provide <b>view</b> <i>backed</i>
by the map. Map's changes are reflected in the set, and
vise-verse. If elements are removed from the view, the
corresponding mappings are <b>removed</b> from the map.
</li>
</ul>
</li>
<li>
<b>LinkedHashMap</b> is similar to HashMap but have an added property
that iterating over the <b>keys</b> will be in the same order as
<b>insertion</b>. However, this is the most expensive JDK collection in
terms of memory consumption per element.
</li>
<li id="interface &lt;b&gt;SortedMap&lt;/b&gt;">A map that provides a total ordering on its
keys.
<ul class="org-ul">
<li>The order is reflected when iterating over the sorted map's
collection views (returned by <code>entrySet</code>, <code>keySet</code>, and <code>values</code> methods).
</li>
<li>Implements by <b>TreeMap</b>
</li>
</ul>
</li>
<li id="interface &lt;b&gt;NavigableMap&lt;/b&gt;">A <b>SortedMap</b> extended with navigation
methods returning the closest matches for given search target.
<ul class="org-ul">
<li>
<code>lowEntry</code>, <code>flowEntry</code>, <code>ceilingEntry</code>, <code>higherEntry</code> returns
<code>Map.Entry</code> objects whose key respectively <i>less then</i>, <i>less than
or equal</i>, <i>greater than or equal</i>, <i>greater than</i> the given key.
</li>
<li>
<code>headMap(until)</code>, <code>tailMap(from)</code>, and <code>subMap(from, to)</code> return
subset of the mapping entries given the search condition.
</li>
</ul>
</li>
<li>TreeMap implements both <b>SortedMap</b> and <b>NavigableMap</b>
<ul class="org-ul">
<li>It uses a <b>red-black tree</b> with each node in the tree is a
key-value pair.
</li>
<li>Each elements put into the TreeMap rebalanced the tree.
</li>
</ul>
</li>
<li>EnumMap - a map with enum keys
</li>
<li id="&lt;b&gt;IdentityHashMap&lt;/b&gt;">it a special version of map. It <b>violates</b> the
Map general contract : it compares references using <code>==</code> instead of
<code>Object.equals</code>.
<ul class="org-ul">
<li>Useful for various graph traversal algorithms: you may easily
store already processed nodes in the <b>IdentityHashMap</b> along with
some node-related data.
</li>
</ul>
</li>
<li id="&lt;b&gt;WeakHashMap&lt;/b&gt;">keeps its key with WeakReference, which is subject to
GC. Values are, however, stored using strong
reference.
<ul class="org-ul">
<li>Useful for data cache implementations.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-6-8" class="outline-4">
<h4 id="sec-1-6-8">Concurrent Collections</h4>
<div class="outline-text-4" id="text-1-6-8">
<ul class="org-ul">
<li>
<b>CopyOnWriteArrayList</b>: making a copy of underlying array on each
update. Should be used when traversal seriously outnumbering
updates.
<ul class="org-ul">
<li>Useful for listener/observers.
</li>
<li>No synchronization is necessary, even during iteration.
</li>
</ul>
</li>
<li>
<b>CopyOnWriteArraySet</b>: based on a copy-on-write array.
</li>
<li id="&lt;b&gt;ConcurrentHashMap&lt;/b&gt;">
</li>
<li id="&lt;b&gt;ConcurrentLinkedQueue&lt;/b&gt;">A unbounded thread-safe queue based on
linked nodes.
</li>
<li>
<b>ConcurrentSkipListMap</b>
</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7">Java 8 Stream</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>The processing Order
<ul class="org-ul">
<li>Intermediate operations will only be executed when a terminal
operation is present.
</li>
<li>Each elements in the stream moves along the chain vertically, not
all elements processed together in each intermediate operations.
</li>
</ul>
</li>
<li>Reusing Streams.
<ul class="org-ul">
<li>Java 8 stream cannot be reused.
</li>
<li>As soon as you call any terminal operation, the stream is closed.
</li>
<li>We have to create a new stream chain for every terminal operation
we want to execute.
</li>
</ul>
</li>
<li>Intermediate operations.
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left">Function</th>
<th scope="col" class="left">Preserve count</th>
<th scope="col" class="left">Preserve type</th>
<th scope="col" class="left">Perserve order</th>
</tr></thead>
<tbody>
<tr>
<td class="left"><code>map</code></td>
<td class="left">Y</td>
<td class="left">N</td>
<td class="left">Y</td>
</tr>
<tr>
<td class="left"><code>filter</code></td>
<td class="left">N</td>
<td class="left">Y</td>
<td class="left">Y</td>
</tr>
<tr>
<td class="left"><code>distinct</code></td>
<td class="left">N</td>
<td class="left">Y</td>
<td class="left">Y</td>
</tr>
<tr>
<td class="left"><code>sorted</code></td>
<td class="left">Y</td>
<td class="left">Y</td>
<td class="left">N</td>
</tr>
<tr>
<td class="left"><code>peek</code></td>
<td class="left">Y</td>
<td class="left">Y</td>
<td class="left">Y</td>
</tr>
</tbody>
</table>
</li>

<li>
<b>Collectors</b> : transform the elements of the stream into a different
kind of result.
<ul class="org-ul">
<li>
<code>toList</code>, <code>toSet</code>, <code>toMap</code>
</li>
<li>
<code>averagingInt</code>, <code>summarizingInt</code>
</li>
<li>
<code>joining</code>: accepts a delimiter and optional prefix and suffix.
</li>
</ul>
</li>
<li>One important thing to note is that parallel streams achieve
parallelism through threads using the existing common
<b>ForkJoinPool</b>.
<ul class="org-ul">
<li>As a result, there are possible complications:
<ul class="org-ul">
<li>
<a href="https://zeroturnaround.com/rebellabs/java-parallel-streams-are-bad-for-your-health/">https://zeroturnaround.com/rebellabs/java-parallel-streams-are-bad-for-your-health/</a>
</li>
<li>The common pool is upper limited (can be changed with a system
property) with <code>Runtime.availableProcessors()</code>, it is possible
to block all the threads in it and thus exhaust the pool.
</li>
<li>If you know the Job in the parallel stream is going to block for
some time, it will be better to use a <code>interface
      ForkJoinPool.ManagedBlocker</code>.
</li>
</ul>
</li>
</ul>
</li>
<li>Parallel streams are <b>unpredictable</b> and complex to use correctly.
<ul class="org-ul">
<li>Almost any use of parallel streams can affect the performance of
other <b>unrelated</b> system components in an <b>unpredictable way</b>.
</li>
</ul>
</li>

<li>
<b>Starvation</b> describes a situation where a thread is unable to gain
regular access to shared resources and is unable to make
progress.
<ul class="org-ul">
<li>This happens when shared resources are made unavailable for long
periods by "greedy" threads.
</li>
<li>For example, suppose an object provides a synchronized method
that often takes a long time to return.
</li>
<li>If one thread invokes this method frequently, other threads that
also need frequent synchronized access to the same object will
often be blocked.
</li>
</ul>
</li>
<li>
<b>Livelock</b> A thread often acts in response to the action of another
thread. If the other thread's action is also a response to the
action of another thread, then livelock may result.
<ul class="org-ul">
<li>As with deadlock, livelocked threads are unable to make further
progress.
</li>
<li>However, the threads are not blocked  they are simply too busy
responding to each other to resume work.
</li>
<li>This is comparable to two people attempting to pass each other
in a corridor: Alphonse moves to his left to let Gaston pass,
while Gaston moves to his right to let Alphonse pass. Seeing
that they are still blocking each other, Alphone moves to his
right, while Gaston moves to his left. They're still blocking
each other, so
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8">Design Patterns</h3>
<div class="outline-text-3" id="text-1-8">
<dl class="org-dl">
<dt> Strategy Pattern </dt>
<dd>enables you to defer decisions about which
implementation to use until <i>run time</i>.
<ul class="org-ul">
<li>The Spring Framework uses an XML file to construct objects and
their dependencies, which are read at runtime, allowing a quick
change between implementations without any need for recompilation.
</li>
</ul>
</dd>
<dt> Template Pattern </dt>
<dd>is used to defer to delegate some, or all steps
of an algorithm to a subclass. Common behaviour can be defined in
a superclass, then specific variants are written in a subclass.
</dd>
<dt> Decorator Pattern </dt>
<dd>enables you to change or configure the
functionality of a specific object.
<ul class="org-ul">
<li>It takes an instance of same abstract/interface type which adds
additional behaviour.
</li>
<li>Java's IO class use the Decorator Pattern extensively.
</li>
<li>java.util.Collections, the <code>checkedXXX()</code>, <code>synchronizedXXX()</code> and
<code>unmodifiableXXX()</code> methods.
</li>
</ul>
</dd>
<dt> Flyweight Pattern </dt>
<dd>can be used when you have several objects, and
many may represent the same value. In these instances, it can be
possbile to share the values as long as the objects are immutable.
<ul class="org-ul">
<li>
<b>Integer</b> class is an implementation of the flyweight pattern:
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">){</span>
    <span class="k">assert</span> <span class="n">IntegerCache</span><span class="o">.</span><span class="na">high</span> <span class="o">&gt;=</span><span class="mi">127</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span><span class="n">IntegerCache</span><span class="o">.</span><span class="na">low</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IntegerCache</span><span class="o">.</span><span class="na">high</span><span class="o">){</span>
	<span class="k">return</span> <span class="n">IntegerCache</span><span class="o">.</span><span class="na">cache</span><span class="o">[</span><span class="n">i</span> <span class="o">+</span> <span class="o">(-</span><span class="n">IntegerCache</span><span class="o">.</span><span class="na">low</span><span class="o">)];</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p>
The default range of the cache is -128 to 127. The cache is
initialized in a static block and is created the first time an
Integer is referenced.
</p>
</li>
<li>Another implementation of the Flyweight Pattern is called <b>Null
Object Pattern</b>, which uses a flyweight object to represent
<code>null</code>. For example in tree implementation, a <b>NullObject</b> can be
used to represent non-children.
</li>
</ul>
</dd>
<dt> Singleton </dt>
<dd>using <b>Enum</b>, JVM will guarantee that only one
instance will ever be created.
<div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">enum</span> <span class="n">SingletonEnum</span> <span class="o">{</span>
    <span class="n">INSTANCE</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">singletonMethod</span><span class="o">{</span>
	<span class="c1">//operation here.</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>Singletons work best in specialized applications such as GUI on
a desktop or mobile application. Or you know you will not have
many concurrent users.
</li>
<li>If you are building large, scalable server applications,
singleton objects are often the source of many performance
bottlenecks.
</li>
<li>
<code>java.lang.Runtime#getRuntime()</code>
</li>
<li>
<code>java.awt.Desktop#getDesktop()</code>
</li>
</ul>
</dd>
<dt> Abstract Factory </dt>
<dd>creational methods returning the <b>factory
itself</b> which in turn can be used to create other abstract types.
<ul class="org-ul">
<li>
<code>javax.xml.parsers.DocumentBuilderFactory#newInstance()</code>
</li>
<li>
<code>javax.xml.transform.TransformerFactory#newInstance()</code>
</li>
</ul>
</dd>
<dt> Factory Method </dt>
<dd>Creational methods returning an implementation of
an abstract/interface type.
<ul class="org-ul">
<li>
<code>java.util.Calendar#getInstance()</code>
</li>
<li>
<code>java.util.ResourceBundle#getBundle()</code>
</li>
<li>
<code>java.text.NumberFormat#getInstance()</code>
</li>
<li>
<code>java.nio.charset.Charset#forName()</code>
</li>
</ul>
</dd>
<dt> (no term) </dt>
<dd>Builder
<ul class="org-ul">
<li>The Implementations of <b>java.lang.Appendable</b> are
builders. <b>Appendable</b> is an object which char sequences
(<b>java.lang.CharSequence</b>) and values can be appended. It must be
implemented by class whose instances are intended to receive
formatted output from a Formatter.
</li>
</ul>
</dd>
<dt> Prototype </dt>
<dd>Creational methods returning a different instance of
itself with same properties
<ul class="org-ul">
<li>
<code>java.lang.Object#clone()</code>
</li>
</ul>
</dd>
<dt> Chain of Responsibility </dt>
<dd>Behaviour methods which indirectly
invokes the same method in another implementation of same
abstract/interface type <b>in a queue</b>.
<ul class="org-ul">
<li>
<code>java.util.logging.Logger#log()</code>
</li>
<li>
<code>javax.servlet.Filter#doFilter()</code>
</li>
</ul>
</dd>
<dt> State </dt>
<dd>Behaviour methods which changes its behaviour depending on
the instance's state, which can be controlled externally.
<ul class="org-ul">
<li>provides behaviour to an object so that it can be changed during
runtime.
</li>
<li>Very similar to <b>Bridge</b> pattern but intention is different:
<ul class="org-ul">
<li>Bridge is structural: hide data from client, and client only
aware of the handle.
</li>
<li>State is behavioral: provides <i>flexible behavior</i> of owning object
and client would be aware of <b>both</b> owning object and state objects.
</li>
</ul>
</li>
</ul>
</dd>
<dt> Bridge </dt>
<dd>decouples an abstraction from the implementation of its
abstract operations, so that abstraction and its
implementation can vary <b>independently</b>.
<ul class="org-ul">
<li>AWT: provides an abstract layer which maps onto the native OS.
</li>
<li>JDBC
</li>
</ul>
</dd>
<dt> Template method </dt>
<dd>allows subclasses to override parts of the method
without rewriting it; also allow you to control whichh operations
subclasses are required to override.
</dd>
<dt> Adapter </dt>
<dd>convert the interface of a class into another interface
clients expect.
<ul class="org-ul">
<li>
<code>java.io.InputStreamReader</code>, <code>java.io.OutputStreamWriter</code>
</li>
</ul>
</dd>
<dt> Memento </dt>
<dd>capture the internal state of an object without violating
encapsulation and thus providing a mean for restoring the
object into initial state when needed.
<ul class="org-ul">
<li>
<code>java.util.Date</code>: internally represented by a long value.
</li>
<li>
<code>java.io.Serializable</code>
</li>
</ul>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9">Datatype</h3>
<div class="outline-text-3" id="text-1-9">
<ul class="org-ul">
<li>Two's Complement representation
<ul class="org-ul">
<li>Storage of binary values of short, int, and long.
</li>
<li>The negative equivalent of possitive value is calculated by
applying a binary NOT and then add 1.
</li>
<li>There is only one value for zero: there is no concept of a
negative zero.
</li>
<li>Which in tun, means the system can store one extra negative value.
</li>
<li>The most negative number(<b>Integer.MIN<sub>VALUE</sub></b>), has the most
significant bit of 1, and all remaining bits are zeros.
</li>
<li>The most negative number's abs() will fail, no corresponding
positive value for it.
</li>
</ul>
</li>
<li id="BigInteger">Immutable <b>arbitrary-precision</b> integers.
<ul class="org-ul">
<li>Effectively unbounded.
</li>
<li>Has all the methods that can would normally applied on an Integer.
</li>
<li>All operations behave as if BigIntegers were represented in
<b>two's-complement</b> notation (like Java's primitive integer types).
</li>
<li>
<code>gcd(BigInteger val)</code>: return the greatest common divisor.
</li>
<li>
<code>isProbablyPrime()</code> : return ture if is probably prime, false if
it definitely composite.
</li>
</ul>
</li>
<li id="BigDecimal">Immutable <b>arbitrary-precision</b> decimal numbers.
</li>
<li>
<b>AtomicLong</b> and <b>AtomicInteger</b> are also subclass of <b>Number</b>.
</li>
<li id="&lt;b&gt;String&lt;/b&gt;"><ul class="org-ul">
<li>String constructor which take byte or char array, will copy the
array for the String.
</li>
<li>static methods
<ul class="org-ul">
<li>
<code>format(String format, Object... args)</code>
</li>
<li>
<code>join(CharSequence delimiter, CharSequence... elements)</code>
</li>
</ul>
</li>
<li>String intern: When the class is loaded by the JVM, it holds all
the literals in a constants pool. Any repettion of a String
literal can be referenced from the same constant in the pool.
<ul class="org-ul">
<li>The String intern pool is not just open to compile-time String
literals; any String instance can be added to this pool with the
intern() method.
</li>
<li>When the intern method is invoked, if the pool already contains
a string equal to this String object as determined by the
<code>equals(Object)</code> method, then the string from the pool is
returned. Otherwise, this String object is added to the pool and
a reference to this String object is returned.
</li>
<li>It follows that for any two strings <code>s</code> and <code>t</code>, <code>s.intern() ==
      t.intern()</code> is <code>true</code> if and only if <code>s.equals(t)</code> is <code>true</code>.
</li>
<li>In Java 6, interned strings were stored in the <b>PermGen</b>  the
<b>fixed size</b> part of heap mainly used for storing loaded classes
and string pool. using intern() might lead to out of memory in
the <b>PermGen</b>.
</li>
<li>Since Java 7: the string pool was relocated to the heap.
</li>
<li>String pool values can be GC as well.
</li>
<li>String pool is implemented as a HashMap, with its key being its
hashcode. and the map size can be set with <code>-XX:StringTableSize</code>.
</li>
<li>The String constant pool is an implementation of the <b>Flyweight</b>
      pattern.
</li>
</ul>
</li>
</ul></li>
<li>Exception
<ul class="org-ul">
<li>the author's opition is to favor runtime exceptions and be
explicit in any documentation as to what exactly may be thrown to
any clients calling that method.
</li>
<li>Modern languages such as <b>Scala</b> have stepped away from checked
exceptions, and have only runtime exceptions.
</li>
</ul>
</li>
<li>Why do fields that are private also need to be marked as final to
make them immutable?
<ul class="org-ul">
<li>The private field can be manipulated using the <b>Reflection
API</b>. Reflection API has the ability to access and mutate all
fields, regardless of their visibility.
</li>
<li>The final modifier instructs the JVM that no modifications are
allowed on that field at all.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10">Libraries</h3>
<div class="outline-text-3" id="text-1-10">
<ul class="org-ul">
<li>It is advisiable to use the <b>expected</b> parameter on the <b>@Test</b>
annotation sparingly. The most reliable tests using this parameter
have only one line in the method body: the line that should throw
the exception.
</li>
<li>How can a test fail if it does not complete quickly enough?
<ul class="org-ul">
<li>The @Test annotation can take a <b>timeout</b> parameter, which takes a
value of type long.
</li>
<li>If the test is running for longer than the timeout specified, the
test fails.
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Functional Programming in Java</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>The <code>Iterable</code> interface has been enhanced in Java 8 with a special
method <code>forEach()</code>, which accept a <code>Consumer</code>.
</li>
<li>However, once <code>forEach</code> starts, we cannot break out of the
iteration.
</li>
<li>Thus this style is useful in the common case where we want to
process each element in a collection.
</li>
<li>Lambda function with inferred parameters: the parameters are
<code>non-final</code>.
<div class="highlight"><pre><span></span><span class="n">friends</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
<span class="c1">//or, with the inferred type, cannot specify final here.</span>
<span class="n">friends</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">name</span><span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
<span class="c1">//or.</span>
<span class="n">friends</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</pre></div>
</li>
<li>In Java you can use lambdas and method references when any <b>SAM</b>
  (single abstract method) interface is expected.
<ul class="org-ul">
<li>Lambdas can be freely converted to SAM Types.
<ul class="org-ul">
<li>Example:
<div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">startsWithN</span> <span class="o">=</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"N"</span><span class="o">);</span>
<span class="c1">//or using a Lexical scoping with closure.</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">checkIfStartsWith</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">letter</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">letter</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//or with *Function* Interface.</span>
<span class="kd">final</span> <span class="n">Function</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">startsWithLetter</span> <span class="o">=</span>
    <span class="n">letter</span> <span class="o">-&gt;</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">letter</span><span class="o">);</span>
</pre></div>
</li>
<li>This can also help with reuse of lambda expression, if it is
used multiple times.
</li>
<li>From within a lambda expression we can only access local
variables that are <code>final</code> or <code>effectively final</code> in the
enclosing scope.
</li>
<li>A lambda expression may be invoked right away, or it may be
invoked lazily or from multiple thread.
</li>
<li>To avoid race conditions, the local variables we access in the
enclosing scope are not allowed to change once initialized.
</li>
<li>Variables either marked as <code>final</code>.
</li>
<li>Or for <code>effectively final</code>
<ul class="org-ul">
<li>the variables have to be initialized within the enclosing
method before the lambda expression is defined.
</li>
<li>the values of these variable don't change anywhere else.
</li>
</ul>
</li>
</ul>
</li>
<li>In Scala, it is only supported from version 2.12, so a scala
function literal can be used for a <b>SAM</b>.
<ul class="org-ul">
<li>If a <code>trait/abstract class</code> with exactly one <code>abstract</code> method,
then a <b>Function</b> of the same parameter and return type of the
abstract method can be converted into the <code>trait/abstract
      class</code>.
</li>
<li>Example:
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">Flyable</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">fly</span><span class="o">(</span><span class="n">miles</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Unit</span>
  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="s">"Unindentified Flyable Object"</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">ufo</span><span class="k">:</span> <span class="kt">Flyable</span> <span class="o">=</span> <span class="o">(</span><span class="n">m</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s"</span><span class="si">${</span><span class="n">ufo</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s"> flies </span><span class="si">$m</span><span class="s"> miles"</span><span class="o">)</span>
<span class="n">ufo</span><span class="o">.</span><span class="n">fly</span><span class="o">(</span><span class="mi">123</span><span class="o">)</span>
<span class="c1">//Unidentified Flyable Object files 123 miles!</span>
</pre></div>
</li>
</ul>
</li>
</ul>
</li>
<li>Picking an element from collection, using <code>findFirst()</code> method,
which return a <code>Optional</code>:
<div class="highlight"><pre><span></span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">foundName</span> <span class="o">=</span>
   <span class="n">names</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"N"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">findFirst</span><span class="o">();</span>
</pre></div>
</li>
<li>
<code>reduce</code>
<ul class="org-ul">
<li>An <code>Optional reduce(BinaryOperator bo)</code> example, finding the name with the longest length:
<div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">aLongName</span> <span class="o">=</span>
   <span class="n">friends</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span>
     <span class="n">reduce</span><span class="o">((</span><span class="n">name1</span><span class="o">,</span> <span class="n">name2</span><span class="o">)=&gt;</span> <span class="n">name1</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;=</span><span class="n">name2</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">?</span> <span class="n">name1</span> <span class="o">:</span> <span class="n">name2</span><span class="o">);</span>
<span class="n">aLongName</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">name</span><span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"A long name: "</span><span class="o">+</span> <span class="n">name</span><span class="o">));</span>
</pre></div>
<ul class="org-ul">
<li>As the <code>reduce()</code> method iterated through the collection, it called
the lambda expression first with the first two elements in the
list.
</li>
<li>The result is used as the <b>first</b> parameter in the following calls.
</li>
<li>The result from the final call is returned as the result of the
<code>reduce()</code> method call.
</li>
<li>The result of <code>reduce()</code> is an <code>Optional</code> because the collection
on which is called may be empty.
</li>
<li>If the list had only one element, the <code>reduce()</code> would return that
element and the lambda expression would not be invoked.
</li>
</ul>
</li>
<li>Another form of <code>reduce</code> looks like:
<div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">steveOrLonger</span> <span class="o">=</span>
    <span class="n">friends</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
    <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="s">"steve"</span><span class="o">,</span> <span class="o">(</span><span class="n">name1</span><span class="o">,</span> <span class="n">name2</span><span class="o">)</span> <span class="o">-&gt;</span>
	    <span class="n">name1</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;=</span><span class="n">name2</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">?</span> <span class="n">name1</span><span class="o">,</span> <span class="n">name2</span>
	<span class="o">);</span>
</pre></div>
<ul class="org-ul">
<li>It takes a base value, and not return an <code>Optional</code>.
</li>
</ul>
</li>
</ul>
</li>
<li>Join elements:
<ul class="org-ul">
<li>
<code>String</code> has an added convenience method <code>join()</code>:
<div class="highlight"><pre><span></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">", "</span><span class="o">,</span> <span class="n">friends</span><span class="o">));</span>
</pre></div>
</li>
<li>Under the hood, the <code>join()</code> method calls upon the <code>StringJoiner</code>
    to concatenate the values.
</li>
<li>We could use the <code>reduce()</code> method to concatenate elements into a
string, but JDK has a <code>collect()</code> method, which is another form of
<code>reduce</code> that can help collect values into a target destination:
<div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">names</span> <span class="o">=</span> <span class="n">friends</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">String</span><span class="o">::</span><span class="n">toUpperCase</span><span class="o">)</span>
    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">", "</span><span class="o">))</span>
</pre></div>
</li>
<li>
<code>StringJoiner</code> gives more control over the format of
concatenation; we can specify a prefix, a suffix, and infix
character sequences.
</li>
</ul>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/java-problems/" class="u-url">Java Problems</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/java-problems/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Unable to connect through SSL/HTTPS</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">The problem</h3>
<div class="outline-text-3" id="text-1-1">
<p>
When trying to connect through a HTTPS connection, the java
HTTPConnection through the following exception:
</p>
<p class="verse">
Caused by: javax.net.ssl.SSLHandshakeException: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target<br>
at sun.security.ssl.Alerts.getSSLException(Alerts.java:192) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.SSLSocketImpl.fatal(SSLSocketImpl.java:1949) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.Handshaker.fatalSE(Handshaker.java:302) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.Handshaker.fatalSE(Handshaker.java:296) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.ClientHandshaker.serverCertificate(ClientHandshaker.java:1509) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.ClientHandshaker.processMessage(ClientHandshaker.java:216) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.Handshaker.processLoop(Handshaker.java:979) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.Handshaker.process<sub>record</sub>(Handshaker.java:914) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:1062) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1375) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1403) ~[na:1.8.0<sub>65]</sub><br>
at sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:1387) ~[na:1.8.0<sub>65]</sub><br>
at sun.net.www.protocol.https.HttpsClient.afterConnect(HttpsClient.java:559) ~[na:1.8.0<sub>65]</sub><br>
at sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:185) ~[na:1.8.0<sub>65]</sub><br>
at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1513) ~[na:1.8.0<sub>65]</sub><br>
at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1441) ~[na:1.8.0<sub>65]</sub><br>
at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480) ~[na:1.8.0<sub>65]</sub><br></p>
<p>
The HTTPS certficate is issued with letsencrypt.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Cause</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Whenever Java attempts to connect to another application over SSL (e.g.: HTTPS,
IMAPS, LDAPS), it will only be able to connect to that application if
it can trust it.
</p>

<p>
The way trust is handled in the Java world is that you have a keystore
(typically <b>$JAVA<sub>HOME</sub>/lib/security/cacerts</b>), also known as the
<b>truststore</b>. This contains a list of <b>all</b> known Certificate
Authority (CA) certificates, and Java will only trust certificates
that are signed by one of those CAs or public certificates that exist
within that keystore.
</p>

<p>
For example, if we look at the certificate for Atlassian, we can see
that the <b>*.atlassian.com</b> certificate has been signed by the
intermediate certificates, <b>DigiCert High Assurance EV Root CA</b> and
<b>DigiCert High Assurance CA-3</b>. These intermediate certificates have
been signed by the root <b>Entrust.net Secure Server CA</b>.
</p>

<p>
Theese three certificates combined are referred to as the certificate
chain. As they are all within the Java keystore, Java will trust any
certificates signed by them.
</p>

<p>
Alternatively, if the <b>.atlassian.com</b> certificate had been in the
keystore, Java would also trust that site.
</p>

<p>
This problem is therefore caused by a certificate that is <i>self-signed</i>
(a CA did not sign it) or <b>a certificate chain that does not exist
within the Java truststore</b>. Java does not trust the certificate and
fails to connect to the application.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Resolution</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Make sure you have imported the public certificate of the target
instance into the truststore.
</li>
<li>Make sure any certificates have been imported into the correct
truststore; you may have multiple JRE/JDKs.
</li>
<li>Check to see that the correct truststore is in use. If
<b>-Djavax.net.ssl.trustStore</b> has been configured, it will override
the location of the default truststore, which will need to be
checked.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">Specific on the Letsencrypt certificates</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Up until Java 8u101, Java don't trust Let's Encrypt certificates out
of the box. The truststore of Oracle JDK/JRE contains neither the
Let's Encrypt CA specifically, or the IdenTrust CA that cross signed it.
</p>

<p>
For a local configuration changes:
</p>
<div class="highlight"><pre><span></span>keytool -trustcacerts <span class="se">\</span>
    -keystore <span class="nv">$JAVA_HOME</span>/jre/lib/security/cacerts <span class="se">\</span>
    -storepass changeit <span class="se">\</span>
    -noprompt <span class="se">\</span>
    -importcert <span class="se">\</span>
    -file /etc/letsencrypt/live/hostname.com/chain.pem
</pre></div>

<p>
To update the java version to the latest on RaspberryPi, following:
<a href="https://www.linuxbabe.com/desktop-linux/install-oracle-java-8-debian-jessie-raspbian-jessie-via-ppa">https://www.linuxbabe.com/desktop-linux/install-oracle-java-8-debian-jessie-raspbian-jessie-via-ppa</a>
</p>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/java-troubleshooting/" class="u-url">Java Troubleshotting Note</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/java-troubleshooting/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Options/Flags for JVM trobuleshotting</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Core files: If java crashes, for example due to a segmentation
fault, the OS saves to disk a core file (complete dump of the
memory).
<ul class="org-ul">
<li>On linux, using <code>ulimit -c unlimited</code> before starting the
application will usually enable core file dump.
</li>
<li>to force on core file when the application cannot be closed
properly, using <br><code>kill -6 &lt;pid&gt;</code>
</li>
</ul>
</li>
<li>Heap dump: add <code>-XX:+HeapDUmpOnOutOfMemoryError</code> flags save java
heap dump to disk if the application runs into an
<b>OutOfMemoryError</b>. <code>jhat</code> can be used to inspect the Java heap.
</li>
<li>Using a continious Java flight recording (JFR).
<ul class="org-ul">
<li>The JFR events can be extremely helpful to debug a wide range of
issues from <i>memory leaks</i> to <i>network errors</i>, high CPU usage/, <i>thread
blocks</i>, etc.
</li>
<li>The overhead of running with a continious flight recording is <b>very low</b>.
</li>
</ul>
</li>
<li>Verbose GC with <code>-verbosegc</code>:
<ul class="org-ul">
<li>Does GC run for a long time?
</li>
<li>Does the free memory decrease over time?
</li>
<li>Use flags <code>UseGClogFileRotation</code> and <code>NumberOfGCLogFiles</code> to set
up log rotation.
</li>
</ul>
</li>
<li>Print Java version and JVM flags:
<ul class="org-ul">
<li>Using <code>-XX:+PrintCommandLineFlags</code>
</li>
<li>and <code>-showversion</code>
</li>
</ul>
</li>
<li>Set up JMC JMX for remote monitoring:
<ul class="org-ul">
<li>There is no performance overhead in enabling JMX
</li>
<li>To enable JMX after java application has started using the
diagnostic command <b>ManageAgent.start</b>, run <br><code>jcmd &lt;pid&gt; help ManagementAgent.start</code> <br>
    for a list of flags that can be send with the command
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Java Mission Control</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Java Management console (JMX) connects to a running JVM, collects
and displays key characterstics in real time.
</li>
<li>Java Flight Recordings (JFR) is available to analyze events.
</li>
<li>JMC can <i>trigger</i> user <span class="underline">provided custom actions and rules</span> for JVM.
</li>
<li>
<b>DTrace</b> plugin is an extended <b>DScript</b> language to produce self
describing events.
</li>
<li>
<b>JOverview</b> plugin is a tool for analyzing heap waste (emtpy/sparse
collections), which use hprof dumps.
</li>
<li>The JMC plugins connect to JVM using JMX agents.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Java Flight Recordings</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>The JFR records detailed information about the java runtime and the
java application running in the java runtime with little overhead.
</li>
<li>Typical events can be threads waiting for locks, GC, periodic CPU
usage data, etc.
</li>
<li>When creating a flight recording, you select which events should be
saved, which is called a <b>recording template</b>.
</li>
<li>A <b>Continuous Recording</b> is a recording that is always on and
saves, for example, the last six hours of data.
<ul class="org-ul">
<li>The default setting for it is to use a recording profile with
extremely low overhead.
</li>
<li>It is great to always have running. The recoding can be dumped
manually using either <b>JCMD</b> or <b>JMC</b>, or set a trigger in JMC to
dump when some criteria is fulfilled.
</li>
<li>It can be started from the command line using <code>-XX:FlightRecorderOptions</code>.
</li>
</ul>
</li>
<li>A <b>Profiling Recordings</b> is a recording that is turned on, runs for
a set amount of time, and then stops. It might have slightly bigger
performance impact. It typical usage includes:
<ul class="org-ul">
<li>Profile what methods are run the most and where most objects are created.
</li>
<li>Look for classes that use more and more heap indicating a memory leak.
</li>
<li>Look for bottle necks due to synchronization.
</li>
<li>The typical overhead for a profiling recording is about <b>2 precent</b>.
</li>
<li>It can be started at the start of the application using
<code>-XX:StartFlightRecording</code> option. For example:<br><div class="highlight"><pre><span></span>java -XX:+UnlockCommercialFeatures -XX:+FlightRecorder <span class="se">\</span>
     -XX:StartFlightRecording<span class="o">=</span><span class="nv">delay</span><span class="o">=</span>20s,duration<span class="o">=</span>60s,name<span class="o">=</span>myrecording,<span class="se">\</span>
     <span class="nv">filename</span><span class="o">=</span>C:<span class="se">\T</span>EMP<span class="se">\m</span>yrecording.jfr,settings<span class="o">=</span>profile MyApp
</pre></div>
</li>
</ul>
</li>
<li>Prior to JDK 8u40 release, the JVM must also have been started with
the flag: <code>-XX:+UnlockCommercialFeatures -XX:FlightRecorder</code>. Since
<b>JDK 8u40</b>, the JFR can <i>be enabled during <b>runtime</b></i>.
</li>
<li>You can also set up JMC to automatically start or dump a flight
recording if a condition is met.
<ul class="org-ul">
<li>There are several default triggers set up for common conditions
such as high CPU usage, deadlocked threads, or too large of a live
set.
</li>
<li>You can choose to create a trigger on <b>any MBean</b> in the application.
</li>
</ul>
</li>
<li>Most GCs in Java have some kind of smaller garbage collections. The
<i>old GC goes through the entire Java heap</i>, while the other GC might
look at part of the heap. The heap usage after an old collection is
the memory the application is using, which is called the <b>live set</b>.
</li>
<li>For a better way to address memory leaks, look at the <i><b>Heap After GC</b>
value in the first and last old GC</i>. There could be a memory leak when
<i>this value is increasing over time</i>.
</li>
<li>
<i>Small objects</i> in Java are allocated in a <b>TLAB (Thread Local Area
Buffer)</b>.
<ul class="org-ul">
<li>TLAB is a small memory area where new objects are allocated.
</li>
<li>Once a TLAB is full, the thread gets a new one. Logging all memory
allocations gives an overhead; therefore, all allocations that
triggered a new TLAB are logged.
</li>
<li>Larger objects are allocated outside TLAB, which are also logged.
</li>
</ul>
</li>
<li>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/javascript-note/" class="u-url">Javascript Notes</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/javascript-note/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">async / await</h2>
<div class="outline-text-2" id="text-1">
<p>
Using <code>async/await</code>  is able to write code that runs asynchronously, but
looks <i>synchronous</i>.
</p>

<p>
Since typescript 2.1, it able to compile down <code>async/await</code> to ES3/ES5
without using any other tools.
</p>

<p>
<a href="https://ponyfoo.com/articles/understanding-javascript-async-await">https://ponyfoo.com/articles/understanding-javascript-async-await</a>
</p>

<ul class="org-ul">
<li>
<code>await</code> may only be used in functions marked with <code>async</code> keywords. It suspends
execution in your context until the promise settles. If the awaited expression
isn't a promise, it is casted into a promise.
<div class="highlight"><pre><span></span><span class="nx">read</span><span class="p">();</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">read</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">getRandomPonyFooArticle</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">md</span> <span class="o">=</span> <span class="nx">hget</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="p">{</span>
	<span class="nx">markdown</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="nx">root</span><span class="o">:</span> <span class="s1">'main'</span><span class="p">,</span>
	<span class="nx">ignore</span><span class="o">:</span> <span class="s1">'.at-subscribe,.mm-comments,.de-sidebar'</span>
    <span class="p">});</span>
    <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nx">marked</span><span class="p">(</span><span class="nx">md</span><span class="p">,</span> <span class="p">{</span>
	<span class="nx">renderer</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Term</span><span class="p">()</span>
    <span class="p">});</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">txt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</li>
<li>Keep in mind that you should wrap <code>await</code> in try / catch so that you can
capture and handle errors in awaited promises from within the async function.
</li>
<li>An <code>async</code> function always returns a Promise. That promise is rejected in the
case of uncaught exceptions, and it is otherwise resolved to the return
value of the <code>async</code> function. This enables us to invoke an <code>async</code> function
and mix that with regular promise-based continuation.
<div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">asyncFun</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">Promise</span>
	<span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">x</span> <span class="p">=&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="p">)</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">asyncFun</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">x</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`x: </span><span class="si">${</span><span class="nx">x</span><span class="si">}</span><span class="sb">`</span><span class="p">));</span>
<span class="c1">// &lt;- 'x: 4'</span>
</pre></div>
</li>
</ul>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Error handling</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Errors are swallowed "silently" within an <code>async</code> function. Unless we add
<code>try / catch</code> blocks around await expressions, uncaught exceptions will
reject the promise returned by <code>async</code> function.
</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">
<b>setInverval</b> and without delay:</h2>
<div class="outline-text-2" id="text-2">
<p>
<i>
http://stackoverflow.com/questions/6685396/execute-the-setinterval-function-without-delay-the-first-time</i>
</p>

<ul class="org-ul">
<li>It is simplest to just call the function directly the first time,
like:
<div class="highlight"><pre><span></span><span class="nx">foo</span><span class="p">();</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="nx">delay</span><span class="p">);</span>
</pre></div>
</li>
<li>
<b>setInterval</b> isn't very reliable and better to avoid:
<ul class="org-ul">
<li>In particular circumstances a whole load of <b>setInterval</b> events
can arrive immediately after each other without any delay.
</li>
<li>Need to remember the handler to cancel using <code>clearInterval</code>.
</li>
<li>
</li>
</ul>
</li>
<li>An alternative is to use <code>setTimeout</code>:
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">foo</span> <span class="p">(){</span>
    <span class="c1">//do stuff for foo.</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">foo</span><span class="p">,</span> <span class="nx">delay</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">foo</span><span class="p">();</span>
</pre></div>
</li>
<li>The above approach <i>ensures that timer events don't <b>STACK</b> if they are left
unprocessed</i>.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Why JSON.stringify doesn't work on native Error object</h2>
<div class="outline-text-2" id="text-3">
<p>
<a href="http://stackoverflow.com/questions/18391212/is-it-not-possible-to-stringify-an-error-using-json-stringify">http://stackoverflow.com/questions/18391212/is-it-not-possible-to-stringify-an-error-using-json-stringify</a>
</p>
<ul class="org-ul">
<li>The reason why it doesn't work is the Error object's properties are
defined as 'enumerable: false':
<div class="highlight"><pre><span></span>var error = new Error('simple error message');
var propertyNames = Object.getOwnPropertyNames(error);
var descriptor;
for (var property, i = 0, len = propertyNames.length; i &lt; len; ++i) {
    property = propertyNames[i];
    descriptor = Object.getOwnPropertyDescriptor(error, property);
    console.log(property, descriptor);
}
</pre></div>
<p>
The output from this shows that:
</p>
<p class="verse">
stack { get: [Function],<br>
set: [Function],<br>
enumerable: false,<br>
configurable: true }<br>
arguments { value: undefined,<br>
writable: true,<br>
enumerable: false,<br>
configurable: true }<br>
type { value: undefined,<br>
writable: true,<br>
enumerable: false,<br>
configurable: true }<br>
message { value: 'simple error message',<br>
writable: true,<br>
enumerable: false,<br>
configurable: true }<br></p>
</li>
<li>
<code>JSON.stringify()</code> can accept an array of String and Number objects
that serve as a whiltelist for selecting/filtering the properties of
the value object to be included in the JSON string
<div class="highlight"><pre><span></span>var error  = new Error("some simple error object")
JSON.stringify(error, Object.getOwnPropertyNames(error));
</pre></div>
<p>
This will print out the Error object's properties as intended.
</p>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/linux-notes/" class="u-url">Linux Note</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/linux-notes/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Linux Memory</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="http://www.inmotionhosting.com/support/website/server-usage/linux-check-memory-usage">http://www.inmotionhosting.com/support/website/server-usage/linux-check-memory-usage</a>
</p>

<ul class="org-ul">
<li>With <code>free -m</code> shows linux memory usage, displayed in MB instead of KB.
The <b>free</b> column besides buffers/cache is the actual free memory available
to linux
</li>

<li>Difference between buffers and cache
A buffer is a temporary location to store data for a particular application
and this data is not used by any other application. Cache is a memory location
to store frequently used data for faster access.
</li>

<li>A process memory layout

<p>
<a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/">http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/</a>
</p>


<div class="figure">
<p><img src="http://static.duartes.org/img/blogPosts/linuxFlexibleAddressSpaceLayout.png" alt="linuxFlexibleAddressSpaceLayout.png"></p>
</div>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Let's Encrypt</h2>
<div class="outline-text-2" id="text-2">
<p>
Using the webroot method to lets encrypt to a Nginx configuration.
</p>

<ol class="org-ol">
<li>With Http only on the nginx config (disable HTTPS first if necessary)

<p class="verse">
server {<br>
listen 80;<br>
server<sub>name</sub> www.graceliu.uk;<br><br>
location '/.well-known/acme-challenge' {<br>
default<sub>type</sub> "text/plain";<br>
root /tmp/letsencrypt-auto;<br>
}<br>
}<br></p>
</li>

<li>Run
<code>./letsencrypt-auto certonly -a webroot  --webroot-path=/tmp/letsencrypt-auto
   -d www.graceliu.uk</code>
</li>

<li>Re-enable https
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Kernel Modules: Load, Unload and Configure</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Linux allows the Kernel to be configured at runtime.
</li>
<li>Modules are stored in /usr/lib/modules/kernel<sub>release</sub>. Module names
often use underscore (_) or dashes (-); however thoese symbols are
interchangeable when using <b>modprobe</b> command and in configuration
files in <span class="underline">/etc/modprobe.d</span>._
</li>
<li>
<i>cli</i> for manipulating the kernel:
<ul class="org-ul">
<li>
<b>depmod</b>: handle dependency descriptions for loadable modules
</li>
<li>
<b>insmod</b>: install loadable module
</li>
<li>
<b>lsmod</b>: list loaded modules
</li>
<li>
<b>modinfo</b>: display information about a kernel module
</li>
<li>
<b>modprobe</b>: high level handling of loadable modules
</li>
<li>
<b>rmmod</b>: unload loadable modules
</li>
</ul>
</li>
<li>to list the options that are set for a loaded module:
<div class="highlight"><pre><span></span>systool -v -m modlue_name
</pre></div>
</li>
<li>All necessary modules loading is handled automatically by
<b>udev</b>, so if you do not need to use any out-of-tree kernel modules,
there is no need to put modules that should be loaded at boot in any
configuration file.
</li>
<li>Kernel modules can be explicitly loaded during boot and are
configured as a static list in files under
<span class="underline">/etc/modules-load.d</span>. Configuration files simply contain a list of
kernel modules names to load, separated by new newlines.
</li>
<li>Manual module handling:
<ul class="org-ul">
<li>To load a module:
<div class="highlight"><pre><span></span>modprobe module_name
</pre></div>
</li>
<li>To load a module by filename (i.e., one that is not installed in
<span class="underline">/lib/modules/$(uname -r)</span>:
<div class="highlight"><pre><span></span>ismod filename <span class="o">[</span>args<span class="o">]</span>
</pre></div>
</li>
<li>To unload a module:
<div class="highlight"><pre><span></span>modprobe -r module_name
<span class="c1"># alternatively:</span>
rmmod module_name
</pre></div>
</li>
</ul>
</li>
<li>Setting module options:
<ul class="org-ul">
<li>Manually at load time using <b>modprobe</b>:
<div class="highlight"><pre><span></span>modprobe module_name <span class="nv">parameter_name</span><span class="o">=</span>parameter_value
</pre></div>
</li>
<li>Using files in <span class="underline">/etc/modprobe.d</span>. Files in this directory can be
used to pass module settings to <b>udev</b>, which will use <b>modprobe</b>
to manage the loading of modules during system boot. File in this
directory can have any name, given that they end with the <i>.conf</i>
extension. The syntax is:
<p class="verse">
options module<sub>name</sub> parameter<sub>name</sub>=parameter<sub>value</sub><br></p>
</li>
<li>If the module is built into the kernel, you can pass options to
the module using the kernel command line. For all common
bootloaders, the following syntax is correct:
<p class="verse">
module<sub>name</sub>.parameter<sub>name</sub>=parameter<sub>value</sub><br></p>
</li>
</ul>
</li>
<li>Blacklisting:
<ul class="org-ul">
<li>Using files in <span class="underline">/etc/modprobe.d</span>:
<p class="verse">
blacklist module<sub>name</sub><br></p>
<p>
The blacklist command will blacklist a module so that it will not
be loaded automatically, but the module may be loaded if another
non-blacklisted module depends on it or if it is loaded manually.
</p>
</li>
<li>Using kernel command line. <span class="underline">This can be very useful if a broken
module makes it impossible to boot your system</span>.
Simply add the following to the bootloader's kernel line:
<p class="verse">
modprobe.blacklist=modname1,modname2,modname3<br></p>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Systemd targets</h2>
<div class="outline-text-2" id="text-4">
<p>
<b>Systemd targets</b> are represented by <i>target units</i>. Target units end with
the <code>.target</code> file extension and their only purpose is to group together
other systemd units through a chain of dependencies.
</p>

<dl class="org-dl">
<dt> List currently loaded target units </dt>
<dd>
<div class="highlight"><pre><span></span>systemctl list-units --type target
</pre></div>
</dd>
<dt> Determine the current default target </dt>
<dd>
<div class="highlight"><pre><span></span>systemctl get-default
</pre></div>
</dd>
<dt> Change the default target </dt>
<dd>
<div class="highlight"><pre><span></span>systemctl set-default name.target
</pre></div>
</dd>
<dt> Change the current target </dt>
<dd>
<div class="highlight"><pre><span></span>systemctl isolate name.target
</pre></div>
</dd>
<dt> Changing to different mode with systemd </dt>
<dd><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
</colgroup>
<tbody>
<tr>
<td class="left">Command</td>
<td class="left">Description</td>
</tr>
<tr>
<td class="left"><code>systemctl halt</code></td>
<td class="left">Halts the system</td>
</tr>
<tr>
<td class="left"><code>systemctl poweroff</code></td>
<td class="left">Powers off the system</td>
</tr>
<tr>
<td class="left"><code>systemctl reboot</code></td>
<td class="left">Restarts the system</td>
</tr>
<tr>
<td class="left"><code>systemctl suspend</code></td>
<td class="left">Suspends the system</td>
</tr>
<tr>
<td class="left"><code>systemctl hibernate</code></td>
<td class="left">Hibernates the system</td>
</tr>
<tr>
<td class="left"><code>systemctl hybrid-sleep</code></td>
<td class="left">Hibernates and suspends the system</td>
</tr>
<tr>
<td class="left"><code>systemctl rescue</code></td>
<td class="left">Enter single user no network rescue mode</td>
</tr>
<tr>
<td class="left"><code>systemctl emergency</code></td>
<td class="left">Enter a minimal emergency mode</td>
</tr>
</tbody>
</table></dd>
<dt> (no term) </dt>
<dd>Reemote control with systemd directly::
<div class="highlight"><pre><span></span>systemctl --host user_name@host_name <span class="nb">command</span>
</pre></div>
</dd>
</dl>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">
<code>find</code> tips</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>To remove the current directory "./" to find subdirectory in.
<ul class="org-ul">
<li>Not only the recursion depth of find can be controlled by the
<code>-maxdepth</code> parameter, the depth can also be limited from top
using the corresponding <code>-mindepth</code> parameter.
</li>
<li>Example:
<div class="highlight"><pre><span></span>find . -mindepth <span class="m">1</span> -type d
</pre></div>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">SSH running remote command.</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>It will return the exit code of the remote command.
<div class="highlight"><pre><span></span>ssh user@somehost today
<span class="nb">echo</span> <span class="nv">$?</span>
</pre></div>
<p>
Output from the above command will be:
</p>
<pre class="example">
bash: today: command not found
127
</pre>
</li>
<li>However, you cannot use conditional control operator:
<ul class="org-ul">
<li>&amp;&amp; : Execute command only if command returns an exit status of zero.
</li>
<li>|| : Execute command only if command returns an exit status of non zero.
</li>
</ul>
</li>
<li>When running remote command like this:
<div class="highlight"><pre><span></span>find . -mindepth <span class="m">1</span> - <span class="nb">type</span> d <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> hostname
<span class="k">do</span>
  ssh <span class="nv">$hostname</span> /some/command/to/run.sh
<span class="k">done</span>
</pre></div>
<p>
This will not work cause the SSH will read the stdin
before the next <code>read</code> run.
</p>
</li>
<li>To run it, need to use <code>ssh -n</code>, It will Redirects stdin from /dev/null (actually, prevents reading
from stdin).
</li>
<li>Read more:
<a href="https://www.cyberciti.biz/faq/linux-unix-osx-bsd-ssh-run-command-on-remote-machine-server/">https://www.cyberciti.biz/faq/linux-unix-osx-bsd-ssh-run-command-on-remote-machine-server/</a>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/microservices-note/" class="u-url">Microservices Note</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/microservices-note/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Challenges</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Monitoring multiple hosts
<ul class="org-ul">
<li>Health Checks: List of health checks is executed on/health
endpoint call:
<ul class="org-ul">
<li>Health check responsible for DB connection
</li>
<li>health check for other external resources
</li>
</ul>
</li>
</ul>
</li>
<li>Configuration of services
<ul class="org-ul">
<li>Use a configuration service: <code>GET /configuration?serviceName=payment</code>
</li>
<li>For example: Spring Cloud has a configuration service.
</li>
</ul>
</li>
<li>Log aggregation
<ul class="org-ul">
<li>Microservices require centralized logging, as there is no one
place to figure out what is going on
</li>
<li>Logstash: data procession pipeline.
</li>
<li>Need some type of <b>global request tracing</b>, assigning a request ID
to each request such that you can figure out how things flow.
</li>
</ul>
</li>
<li>Service discovery
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Asynchronous vs Thread-per-Request Processing</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>IO Intensive:
</li>
<li>CPU Intensive:
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Blue Green Deployment</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>
<a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">https://martinfowler.com/bliki/BlueGreenDeployment.html</a>
</li>
<li>One of the challenges with automating deployment is the cut-over
itself, taking software from the final stage of testing to live
production.
</li>
<li>Need to do this quickly in order to minimize downtime.
</li>
<li>The blue-green deployment approach does this by ensuring you have
two production environment, as identical as possible.
</li>
</ul>
<p>
<i>  https://martinfowler.com/bliki/images/blueGreenDeployment/blue_green_deployments.png</i>
</p>
<ul class="org-ul">
<li>At any time one of them is live, and it is switched when doing deployment.
</li>
<li>Blue-green deployment also gives you a rapid way to rollback.
</li>
<li>There is still issue of dealing with missed <b>transactions</b> during
the switch.
<ul class="org-ul">
<li>keep one as backup when the other is alive, feeding transaction to
both.
</li>
<li>Or put the application in read-only mode before cut-over.
</li>
</ul>
</li>
<li>An advantage of this approach is that it's the same basic mechanism
as you need to get a <b>hot-standby</b> working.
</li>
<li>Hence this allows you to test your disaster-recovery procedure on
every release.
</li>
<li>Databases can often be a challenge with this technique
<ul class="org-ul">
<li>Particularly when you need to change the schema to support a new
version of the software.
</li>
<li>The trick is to <b>separate</b> the <i>deployment of schema changes</i> from
<i>application upgrades</i>.
</li>
<li>First apply a database refactoring to change the schema to support
both the new and old version of the application, deploy that,
check everything is working fine so you have a rollback point,
</li>
<li>Then deploy the new version of the application
</li>
</ul>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/php-note/" class="u-url">PHP Note</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/php-note/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Enable xdebug with hhvm/nginx on remote host</h2>
<div class="outline-text-2" id="text-1">
<p>
In order to enable remote debug, the debug machine (developer machine)
need to be accessible directly from the xdebug server. Xdebug, when inited from
the browser, on the server side, will init the debug session to the
remote/port specified in php.ini.
</p>

<p>
When the developer machine resides inside the router, the remote
machine nomally won't be able to talk directly ot it.
</p>

<p>
To enable the above debug scenario:
x- Using ssh's remote forward to forward the xdebug port to local
  machine (developer machine)
</p>
<ul class="org-ul">
<li>in php.ini, enable xdebug:
<p class="verse">
xdebug.enable=1<br>
xdebug.remote<sub>enable</sub>=1<br>
xdebug.idekey="PHPSTORM"<br>
xdebug.remote<sub>host</sub>=127.0.0.1<br>
xdebug.remote<sub>port</sub>=9000<br></p>
<p>
where the remote<sub>host</sub> and remote<sub>port</sub> will be the address in the ssh
remote forword, xdebug will use this to communicate with the
developer machine.
</p>
</li>
<li>in nginx config for hhvm/php fasgcgi, set:
<p class="verse">
fastcgi<sub>read</sub><sub>timeout</sub> 600;<br></p>
<p>
to prevent gateway timetout while in the debug session.
</p>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">include/require</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>
<code>include()</code> will through a warning if it cannot include the file, but
the rest of the script will run. <code>require()</code> will throw an error and
halt the script if it cannot include the file.
</li>
<li>File are included based on the file path given, or if none is
given, the <span class="underline">include<sub>path</sub></span> specified.
</li>
<li>If the file isn't found in the <span class="underline">include<sub>path</sub></span>, <code>include</code> will
finaly check the calling script's <b>own directory</b> and the <b>current
working directory</b> before falling.
</li>
<li>If a path is defined, either alsolute or relative, <span class="underline">include<sub>path</sub></span>
    will be ignored.
</li>
<li>when a file is include, the code it contains inherits the
<b>variable scope</b> of the line on which the include occurs. However,
all functions and classes defined in the included file have the
<b>global scope</b>.
</li>
<li>If "URL include wrappers" are enabled in PHP, you can specify the
file to  be included using a URL (via HTTP or other supported
wrapper):
<div class="highlight"><pre><span></span>include 'http://www.example.com/file.txt?foo=1&amp;bar=2'
</pre></div>
<p>
It also possbile to include a string as a filename using the
<code>data</code> wrapper:
</p>
<div class="highlight"><pre><span></span>//get content
$cFile = file_get_contents('crypted.file');
//decrypt the content
$content = decrypte($cFile);

//include this
include("data://text/plain;base64,".base64_encode($content));
//or
include("data://text/plain,".urlencode($content));
</pre></div>
</li>
<li>Using $<sub>SERVER['DOCUMENT</sub><sub>ROOT']</sub>:
<div class="highlight"><pre><span></span>include $_SERVER['DOCUMENT_ROOT']."/lib/sample.lib.php";
</pre></div>
<p>
so the script can be move anyehere in the project without changes.
</p>
</li>
<li>If file A includes file B, and B includes file C; the include path
in B should take into account that A, not B, is the active working
directory.
</li>
<li>To avoid issues caused by the above, as a rule of thumb, never
include files using relative paths:
<div class="highlight"><pre><span></span>&lt;?php // prepend.php - autoprepended at the top of your tree
define('MAINDIR',dirname(__FILE__) . '/');
define('DL_DIR',MAINDIR . 'downloads/');
define('LIB_DIR',MAINDIR . 'lib/');

require_once(LIB_DIR . 'excel_functions.php');
</pre></div>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Namespace</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Inside a namespace, when PHP encouters an unqualified Name in a
class name, function or constant context, it resolves with
different priorities:
<ul class="org-ul">
<li>Class names always resolve to the current namespace name. For
example, to refrence <code>Exception</code> in a namespace, will need to
qualified it as <code>\Exception</code>.
</li>
<li>Function and constants, PHP will fall back to global functions
or constants if a namespaced function or constant does not exist.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Anonymous functions and Clousures</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Anonymous functions are implemented using the <code>Closure</code> class. It
is converted into instances of the <code>Closure</code>;
</li>
<li>Closures may also inherit variables from the parent scope. Any
such variables must be passed to the <code>use</code> language construct:
<div class="highlight"><pre><span></span>$message = 'hello';
$example = function () use ($message) {
    var_dump($message);
};
</pre></div>
</li>
<li>Note that when use <code>use</code> to import variable inside closure's
scope, the variable is actually being <b>copied</b> into the closure's
scope, rather than just being make available.
<div class="highlight"><pre><span></span>$result = 0;
$three = function() use (&amp;$result){
    var_dump($result);
};
$result++;
$three();
</pre></div>
</li>
<li>Inheriting variables from the parent scope is not the same as
using global variables. Global variables exist in the global
scope, which is the same no matter what function is executing.
</li>
<li>When anonymous functions are declared in the context of a class,
the current class is automatically bound to it, making <code>$this</code>
available inside of the function's scope.
</li>
<li>If automatic binding of the current class is not wanted, then
<i>static anonymous function</i> may be used:
<div class="highlight"><pre><span></span>new class {
    function __construct()
    {
	(static function() {
	    var_dump($this); //$this will be undefined here.
	}();
    }
};
</pre></div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Logging with Monolog</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>By default, Monolog will use the <code>\Monolog\Handler\StreamHandler</code>
    to log to the standard error output.
</li>
<li>Multiple handler can be set with different log level.
<div class="highlight"><pre><span></span>$browserHanlder = new \Monolog\Handler\BrowserConsoleHandler(\Monolog\Logger::INFO);
$streamHandler = new \Monolog\Handler\StreamHandler('php://stderr', \Monolog\Logger::ERROR);
</pre></div>
<p>
The <code>BrowserConsoleHandler</code> log the messages to the browser's console.
</p>
</li>
<li>There is a bubbling option to allow handler to bubble up the log
messages to above handlers.
</li>
<li>Monolog provides two different ways to add <i>extra information</i>
    along the simple textual message:
<ul class="org-ul">
<li>
<b>logging context</b>:
<div class="highlight"><pre><span></span>$logger-&gt;info('Adding a new user', array('username' =&gt; 'Seldaek'));
</pre></div>
</li>
<li>
<b>Preprocessors</b>: useful for adding more details to your log. For
example, the <code>WebProcessor</code> adds more details about the request,
like url, ip, etc:
<div class="highlight"><pre><span></span>$logger-&gt;pushProcessor(new \Monolog\Processor\WebProcessor);
$browserHanlder = new \Monolog\Handler\BrowserConsoleHandler(\Monolog\Logger::INFO);
$logger-&gt;pushHandler($browserHanlder);
</pre></div>
</li>
</ul>
</li>
<li>Using channels to identify which part of the application a log is related:
<div class="highlight"><pre><span></span> // Create the main logger of the app
$logger = new Logger('my_logger');
// clone the first one to only change the channel
$securityLogger = $logger-&gt;withName('security');
</pre></div>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/programming-note/" class="u-url">Programming Notes</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/programming-note/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">How does a concurrent garbage collector work</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://blog.pusher.com/golangs-real-time-gc-in-theory-and-practice/">https://blog.pusher.com/golangs-real-time-gc-in-theory-and-practice/</a>
</p>

<p>
In golang, its collector runs concurrently with the program. It is called
<i>tricolor mark-and-sweep</i> algorithm.
</p>

<p>
It enables the GC to run concurrently with the program; and means that the pause
times become a <b>scheduling</b> problem. The scheduler can be configured to only run
GC for short periods of time, <i><b>interleaved</b></i> with the program.
</p>

<p>
The details of the algorithm is illustrated in link above.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Overview of the steps</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>The garbage collector assigns objects to three sets: <b>black</b>, <b>grey</b>,
and <b>white</b>. At the beginning of a GC cycle, all objects are put in white set;
</li>
<li>Any newly created object are put in the grey set; The rule is: when a pointer
field is changed, the pointed-to object is coloured;
</li>
<li>At the start of a GC cycle, the root objects are moved to the grey set;
</li>
<li>To scan an object, the collector colours it black, and its children grey;
At any stage, we can count the number of moves the GC has left to do:
<code>2*|white| + |grey|</code>. The collector finished when it reach zero;
</li>
<li>When there is no more grey objects to scan, the white objects are unreachable,
and available for free;
</li>
<li>Swap white and black set for the next GC cycle;
</li>
<li>The GC still has to stop-the-world while scanning for root objects; however in
practice the pause time is &lt;1ms for very large heaps.
</li>
</ul>
<p>
Low latency has costs, the most important cost is reduced <i>throughput</i>.
Concurrency requires extra work for synchronisation and duplication, which eats
into the time program can do useful work.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Some benchmarks</h3>
<div class="outline-text-3" id="text-1-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="right">
</colgroup>
<tbody>
<tr>
<td class="left">Benchmark</td>
<td class="right">Longest pause (ms)</td>
</tr>
<tr>
<td class="left">OCaml</td>
<td class="right">2.21</td>
</tr>
<tr>
<td class="left">Golang</td>
<td class="right">7.01</td>
</tr>
<tr>
<td class="left">Java 1.8</td>
<td class="right">161</td>
</tr>
<tr>
<td class="left">Java 1.8 G1</td>
<td class="right">153</td>
</tr>
</tbody>
</table>
<p>
Java perform very poorly compared.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Takeaway</h3>
<div class="outline-text-3" id="text-1-3">
<p>
GC are either optimised for low latency or high throughput. It is important to
understand the underlying GC algorithm in order to decide whether it is
appropriate  for your use-case.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Zero-copy</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="http://www.linuxjournal.com/article/6345">http://www.linuxjournal.com/article/6345</a>
</p>
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">What Is Zero-Copy.</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Each time data traverses the user-kernel boundary, it must be copied,
which consumes CPU cycles and memory bandwidth.
</p>

<p>
To serve a file over a network socket, some sample code would looks
like:
</p>

<div class="highlight"><pre><span></span><span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">tmp_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="n">write</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">tmp_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</pre></div>


<div class="figure">
<p><img src="http://www.ibm.com/developerworks/library/j-zerocopy/figure1.gif" alt="figure1.gif"></p>
</div>

<p>
Behind those two calls, the data has been copied at least four times,
and almost as many user/kernel context switches have been performed.
</p>

<p>
File is copied from hard drive (DMA copy) to kernel buffer, then from
kernel buffer to user buffer, then from user buffer to socket buffer,
and DMA copy to the protocol engine.
</p>

<p>
One way to eliminate a copy is to skip calling <b>read</b>, and instead
call <b>mmap</b>:
</p>
<div class="highlight"><pre><span></span><span class="n">tem_buf</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="n">write</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">tem_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</pre></div>

<p>
In this case, the context switch remain same. After the file is copied
by DMA copy into kernel buffer, the user space buffer is shared with
the kernel buffer.
</p>

<p>
Another way is to use <b>sendfile</b> system call.
</p>
<div class="highlight"><pre><span></span><span class="n">sendfile</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</pre></div>
<p>
This cause the file contents to be copied into a kernel buffer, then
the data is copied by the kernel into the kernel buffer associated
with sockets.
</p>

<p>
To avoid having the kernel do all the copy, <b>zero-copy</b> is supported by
certain hardware that supports <b>gather</b> operations. This simply means
data data awaiting transmission doesn't need to be in consecutive
memory.
</p>

<p>
With the same <b>sendfile</b> system call, supporint hardware can now avoid
copying data from the kernel buffer to the socket buffer. Instead,
only the descriptors with the information about the wherabouts and
length of the data are appended to the socket buffer. And the DMA
engine passes data directly from the kernel buffer to the protocol
engine, thus eliminating the remaining final copy.
</p>

<p>
When using zero copy, other performance benefits can be had besides
copy avoidance, such as fewer <b>context switches</b>, less CPU data cache
pollution and no CPU checksum calculations.
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2">Java implementation.</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Java input streams can support zero-copy through the
java.nio.channels. <b>FileChannel</b>'s <code>transferTo()</code> method if the underlying
operating system also supports zero copy.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Memory Mapped Files</h2>
<div class="outline-text-2" id="text-3">
<p>
As an alternative to standard file I/O, the kernel provides an
interface that allows an application to map a file into memory,
meaning that there is a one-to-one correspondence between a memory
address and a word in the file. The programmer can then access the
file directly through memory, identically to any other chunk of
memory-resident datait is even possible to allow writes to the memory
region to transparently map back to the file on disk.
</p>


<div class="figure">
<p><img src="https://www.safaribooksonline.com/library/view/linux-system-programming/0596009585/httpatomoreillycomsourceoreillyimages47949.png" alt="httpatomoreillycomsourceoreillyimages47949.png"></p>
</div>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">The page size</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The page is the smallest unit of memory that can have distinct
permissions and behavior. Consequently, the page is the building block
of memory mappings, which in turn are the building blocks of the
process address space.
</p>

<p>
The <b>mmap()</b> system call operates on pages. Both the <code>addr</code> and
<code>offset</code> parameters must be aligned on a <b>page-sized boundary</b>. That
is, they must be integer multiples of the page size. Mappings are,
therefore, integer multiples of pages.
</p>

<p>
If the len parameter provided by the caller is not aligned on a page
boundary, the mapping is rounded up to the <b>next full page</b>.
</p>

<p>
The bytes inside this added memory, between the last valid byte and
the end of the mapping, are <b>zero-filled</b>.
</p>
<ul class="org-ul">
<li>Any read from that region will return zeros.
</li>
<li>Any writes to that memory will not affect the backing file, even if
it is mapped as MAP<sub>SHARED</sub>. Only the original len bytes are ever
written back to the file.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">system calls relating to memory mapped files.</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>The standard POSIX method of obtaining the page size is with
<b>sysconf()</b>
</li>
<li>Linux provides the <b>munmap()</b> system call for removing a mapping
created with *mmap()
</li>
<li>
<b>mremap()</b> system call can be used to expanding or shrinking the
size of a given mapping.
</li>
<li>Synchronizing a File with a mapping, <b>msync()</b> is the equivalent of
the <b>fsync()</b>. A call to <b>msync()</b> flushes back to disk any changes
made to a file mapped via <b>mmap()</b>.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3">Advantages</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>Reading from and writing to a memory-mapped file avoids the
extraneous copy that occurs when using the read( ) or write( )
system calls, where the data must be copied to and from a user-space
buffer.
</li>
<li>Aside from any potential page faults, reading from and writing to a
memory-mapped file does not incur any system call or context switch
overhead. It is as simple as accessing memory.
</li>
<li>When multiple processes map the same object into memory, the data is
shared among all the processes. Read-only and shared writable
mappings are shared in their entirety; private writable mappings
have their not-yet-COW (copy-on-write) pages shared.
</li>
<li>Seeking around the mapping involves trivial pointer
manipulations. There is no need for the lseek( ) system call.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4">Some discussion</h3>
<div class="outline-text-3" id="text-3-4">
<p>
<a href="https://ayende.com/blog/162791/on-memory-mapped-files">https://ayende.com/blog/162791/on-memory-mapped-files</a>
</p>

<p>
So the OS already knows how to evict pages from memory and store them
on the file system, because it needs to do that for the page file.
</p>

<p>
The next step is to make use of that for more than just the page
file. So you can <b>map any file into your memory space</b>. Once that is
done, you can access <i>the part of the memory you have mapped</i> and the OS
will load the relevant parts of the file to memory.
</p>

<p>
The reason you want to do this sort of thing is that it gives you the
ability to work with files as if it was memory.
</p>

<p>
Probably the most important is that you dont have to do <b>manual file
I/O</b>. That can drastically reduce the amount of work you have to do,
and it can also give you a pretty significant perf boost. Because the
I/O is actually being managed by the operation system, you gain a lot
of experience in optimizing
</p>

<p>
It also make it drastically easier to do parallel I/O safely, since
you can read/write from memory concurrently without having to deal
with complex API.
</p>

<p>
Disadvantages: data structures that are good in memory might not
result in good performance if they are stored on disk.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Write-Ahead Logging</h2>
<div class="outline-text-2" id="text-4">
<p>
<a href="https://sqlite.org/wal.html">https://sqlite.org/wal.html</a>
<a href="https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying">https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying</a>
</p>
<ul class="org-ul">
<li>Sometime also called <b>commit logs</b> or <b>transaction logs</b>
</li>
<li>Providing atomicity and durability (two of the ACID properties) in
database systems.
</li>
</ul>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">Logs in Databases</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>The traditional <b>rollback journal</b> works by writing a copy of the
original unchanged database content into a separate rollback journal
file and then writing changes directly into the database file.
<ul class="org-ul">
<li>In event of a crash or <b>ROLLBACK</b>, the original content contained
in the rollback journal is played back to the database file to
revert the file to its original state.
</li>
<li>
<b>COMMIT</b> occurs when the rollback journal is deleted
</li>
</ul>
</li>
<li>The <b>WAL</b> approach inverts the <b>rollback journal</b>'s approach.
<ul class="org-ul">
<li>The original content is preserved in the database file and the
changes are appended into a <b>separated</b> WAL file.
</li>
<li>A <b>COMMIT</b> occurs when a special record indicating a commit is
appended to the WAL.
</li>
<li>A <b>COMMIT</b> can happen without ever writing to the original
database, which allows reader to continue operating from the
original unaltered database, while changes are simultaneously
being committed into the WAL.
</li>
<li>Multiple transactions can be appended to the end of a single WAL
file.
</li>
</ul>
</li>
<li>Moving the WAL file transactions back into the database is called a
<b>checkpoint</b>.
<ul class="org-ul">
<li>By default, SQLite does a checkpoint automatically when the <b>WAL</b>
    file reaches a threadshold size.
</li>
<li>Application can adjust the threshold, or
</li>
<li>Turns off the automatic checkpoints and run checkpointing
manually.
</li>
</ul>
</li>
<li>The sequence of changes that happened on the database is exactly
what is needed to keep a remote replica database in sync.
<ul class="org-ul">
<li>Oracle, MySQL, and PostgreSQL include log shipping protocols to
transmit portions of log to replica databases which act as slaves
</li>
<li>Oracle has productized the logs as a general data subscription
mechanism for no-oracle data subscribers with <b>XStreams</b> and <b>GoldenGate</b>
</li>
<li>Similar facilities in MySQL and PostgreSQL are key components of
many data architectures.
</li>
</ul>
</li>
<li>Logical and Physical Logs:
<dl class="org-dl">
<dt> Logical </dt>
<dd>logging the SQL commands that lead to the row changes
(insert/update/delete statements)
</dd>
<dt> Physical </dt>
<dd>logging the contents of each row that is changed.
</dd>
</dl>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2">Logs in distributed systems</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>The log-centric approach to distributed systems arises from a simple
observation that I will call the State Machine Replication
Principle
<blockquote>
<p>
If two identical, deterministic processes begin in the same state
and get the same inputs in the same order, they will produce the
same output and end in the same state.
</p>
</blockquote>
</li>
<li>You can reduce the problem of making multiple machines all do the
same thing to the problem of implementing a distributed consistent
log to feed these processes input.
</li>
<li>The timestamps that index the log now act as the clock for the state of the
replicas
<ul class="org-ul">
<li>you can describe <i>each replica by a single number</i>, the timestamp
for the maximum log entry it has processed.
</li>
<li>This timestamp combined with the log uniquely captures the entire
<b>state of the replica</b>.
</li>
</ul>
</li>
<li>There are <b>two broad approaches</b> to processing and replication:
<img src="https://content.linkedin.com/content/dam/engineering/en-us/blog/migrated/active_and_passive_arch.png" alt="active_and_passive_arch.png"><dl class="org-dl">
<dt> state machine model </dt>
<dd>
<b>active-active</b> model where we keep a log
of the incoming requests and <b>each replica</b> processes each
request.
</dd>
<dt> primary-backup model </dt>
<dd>to elect one replica as the leader
<ul class="org-ul">
<li>Allow this <b>leader</b> to <b>process</b> requests in the order they
arrive and <i>log out the changes</i> to its state from processing
the requests.
</li>
<li>The other replicas apply in order the state changes the leader
makes so that they will be in sync and ready to take over as
leader should the leader fail.
</li>
</ul>
</dd>
</dl>
</li>
<li>You can see tables and events as dual: tables support <b>data at rest</b>
  and logs <b>capture change</b>.
<ul class="org-ul">
<li>The log, if it is a complete log of changes, holds not only the
contents of the <b>final version of the table</b>, but also allows
recreating all other versions that might have existed.
</li>
<li>It is, effectively, a sort of backup of every previous
state of the table.
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">
<span class="todo TODO">TODO</span> finishing reading blog</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">File system journaling</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>File systems typically use a variant of <b>WAL</b> for at least file system
<b>metadata</b> called journaling.
</li>
<li>Updating file systems to reflect changes to files and directories
usually requires many separate write operations. For example,
to deleting a file on a Unix file system:
<ol class="org-ol">
<li>Removing its directory entry.
</li>
<li>Releasing the inode to the pool of free inodes.
</li>
<li>Returning any blocks used to the pool of free disk blocks
</li>
</ol>
</li>
<li>If there is crash between the steps, there will inconsistencies in
the file system.
<ul class="org-ul">
<li>tools such as <b>fsck</b> is used to detect/recovering such erros.
</li>
<li>normally requires a complete working of its data structures.
</li>
</ul>
</li>
<li>To prevent this, a journaled file system allocates a special
areathe journalin which it records the changes it will make ahead
of time.
</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Programming Tips</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">A simple state machine implementation</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Using Java enum. Enum's ordinal value default to start with 0.
</p>

<div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">volatile</span> <span class="n">State</span> <span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="na">CREATED</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">enum</span> <span class="n">State</span> <span class="o">{</span>
    <span class="n">CREATED</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="n">RUNNING</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="n">REBALANCING</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span> <span class="n">PENDING_SHUTDOWN</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span> <span class="n">NOT_RUNNING</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">validTransitions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>

    <span class="n">State</span><span class="o">(</span><span class="kd">final</span> <span class="n">Integer</span><span class="o">...</span> <span class="n">validTransitions</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">validTransitions</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">validTransitions</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isRunning</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">equals</span><span class="o">(</span><span class="n">RUNNING</span><span class="o">)</span> <span class="o">||</span> <span class="n">equals</span><span class="o">(</span><span class="n">REBALANCING</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCreatedOrRunning</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">isRunning</span><span class="o">()</span> <span class="o">||</span> <span class="n">equals</span><span class="o">(</span><span class="n">CREATED</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValidTransition</span><span class="o">(</span><span class="kd">final</span> <span class="n">State</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">validTransitions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">newState</span><span class="o">.</span><span class="na">ordinal</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<ul class="org-ul">
<li>JDK has a <code>java.util.UUID</code> for generating UUID.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2">Scala call by value vs call by name</h3>
<div class="outline-text-3" id="text-6-2">
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">R</span><span class="o">)</span>   <span class="c1">// call-by-value</span>
<span class="k">def</span> <span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">R</span><span class="o">)</span>  <span class="c1">// call-by-name (lazy parameters)</span>
</pre></div>

<ul class="org-ul">
<li>Call-by-value functions compute the passed-in expression's value
before calling the function, thus the same value is accessed every
time.
</li>
<li>However, call-by-name functions recompute the passed-in expression's
value <b>every time</b> it is accessed inside the function.
</li>
<li>
<code>=&gt; Int</code> is a different type from <code>Int</code>; it's <i><b>function of no
arguments</b> that will generate an Int</i> vs <i>just Int</i>.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3">Scala's inner classes</h3>
<div class="outline-text-3" id="text-6-3">
<p>
<a href="http://docs.scala-lang.org/tutorials/tour/inner-classes.html">http://docs.scala-lang.org/tutorials/tour/inner-classes.html</a>
</p>
</div>
</div>

<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4">Java's FileLock</h3>
<div class="outline-text-3" id="text-6-4">
<p>
<code>java.nio.channels.FileLock</code> provides lock based on a file.
<b>FileLock</b> is a token representing a lock on a region of a file. A
file lock is either <b>exclusive</b> or <b>shared</b>.
</p>

<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">val</span> <span class="n">channel</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">).</span><span class="n">getChannel</span><span class="o">()</span>
<span class="k">val</span> <span class="n">flock</span> <span class="k">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">lock</span><span class="o">()</span>
<span class="c1">// or</span>
<span class="k">val</span> <span class="n">flock</span> <span class="k">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">tryLock</span><span class="o">()</span>
<span class="c1">// or to lock a region</span>
<span class="k">val</span> <span class="n">flock</span> <span class="k">=</span> <span class="n">lock</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">shared</span><span class="o">)</span>
<span class="c1">//to unlock:</span>
<span class="n">flock</span><span class="o">.</span><span class="n">release</span><span class="o">()</span>
</pre></div>

<p>
Directory can be locked using some lock file, for example a file
postfixed with <i>.lock</i> of the <i>directory name</i>.
</p>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/reactive-stream/" class="u-url">Reactive Streams</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/reactive-stream/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Problem</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Handling streams of data  especially "live" data whose volumn is
not predetermined  requires special care in an asynchronous system.
</li>
<li>The most prominent issue is that <b>resource consumption</b> needs to be
controlled such that a <i>fast data source does not overwhelm the steam
destination</i>.
</li>
<li>The main goal is to govern the exchange of stream data across an
asynchronous boundary, while ensuring that the receiving side is not
forced to buffer arbitrary amounts of data.
<ul class="org-ul">
<li>Back pressure is an integral part of this modl in order to allow
the queue which mediate between threads to be <b>bounded</b>.
</li>
</ul>
</li>
<li>In summary, Reactive Streams is a standard and specification for
Stream-oriented libraries for the JVM that:
<ul class="org-ul">
<li>process a potentially <b>unbounded number</b> of elements,
</li>
<li>in sequence,
</li>
<li>
<b>asynchronously</b> passing elements between components,
</li>
<li>with <b>mandatory</b> <i>non-blocking backpressure</i>.
</li>
</ul>
</li>
<li>Publisher: a provider of a potentially unbounded number of sequenced
elements, publishing them according to the *demand received from its
Subscriber(S).
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">RxJava 2</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="https://github.com/ReactiveX/RxJava">https://github.com/ReactiveX/RxJava</a>
</p>
<ul class="org-ul">
<li>RxJava 2 implements Reactive-Streams API.
</li>
<li>RxJava 2 features several base classes you can discover operators on:
<ul class="org-ul">
<li>
<code>io.reactivex.Flowable</code> : 0..N flows, supporting Reactive-Streams and backpressure
</li>
<li>
<code>io.reactivex.Observable</code>: 0..N flows, no backpressure
</li>
<li>
<code>io.reactivex.Single</code>: a flow of exactly 1 item or an error
</li>
<li>
<code>io.reactivex.Completable</code>: a flow without items but only a completion or error signal
</li>
<li>
<code>io.reactivex.Maybe</code>: a flow with no items, exactly one item or an
error.
</li>
</ul>
</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/scala-note/" class="u-url">Scala Note</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Warren Liu
            </span></p>
            <p class="dateline"><a href="posts/scala-note/" rel="bookmark"><time class="published dt-published" datetime="2017-07-14T00:00:00+01:00" title="2017-07-14 00:00">2017-07-14 00:00</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Currying and Partially Applied Functions</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="http://danielwestheide.com/blog/2013/01/30/the-neophytes-guide-to-scala-part-11-currying-and-partially-applied-functions.html">http://danielwestheide.com/blog/2013/01/30/the-neophytes-guide-to-scala-part-11-currying-and-partially-applied-functions.html</a>
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">Assign an existing function/method to a function variable</h3>
<div class="outline-text-3" id="text-1-1">
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span> <span class="k">_</span>
<span class="c1">// or</span>
<span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>
</pre></div>
<p>
This is called a partially applied function.
</p>

<p>
If attemp to assign the cos function/method to a variable:
</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span>
</pre></div>
<p>
It will be an error saying missing arguments for the method.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">Partially applied function</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Passing to a function fewer arguments than it has in its
declaration. Scala does not throw an exception when you provide fewer
arguments to the function, it simply applies them and returns a new
function with rest of arguments that need to be passed.
</p>

<p>
Some example with partial apply functions in scala.
</p>
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Email</span><span class="o">(</span>
  <span class="n">subject</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
  <span class="n">text</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="c1">//type define the EmailFilter as a predicate on email.</span>
<span class="k">type</span> <span class="kt">EmailFilter</span> <span class="o">=</span> <span class="nc">Email</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span>
<span class="c1">//another type define on two integers</span>
<span class="k">type</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Int</span><span class="o">,</span> <span class="nc">Int</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span>
<span class="c1">//with this type, we can have the following predicate.</span>
<span class="k">val</span> <span class="n">gt</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="k">_</span> <span class="o">&gt;</span> <span class="k">_</span>
<span class="k">val</span> <span class="n">ge</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="k">_</span> <span class="o">&gt;=</span> <span class="k">_</span>
<span class="k">val</span> <span class="n">lt</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="k">_</span> <span class="o">&lt;</span> <span class="k">_</span>
<span class="k">val</span> <span class="n">le</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="k">_</span> <span class="o">&lt;=</span> <span class="k">_</span>
<span class="k">val</span> <span class="n">eq</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=</span> <span class="k">_</span> <span class="o">==</span> <span class="k">_</span>

<span class="c1">//a constrain based on the size of email and a relationship to a given integer n.</span>
<span class="k">def</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="n">pred</span><span class="k">:</span> <span class="kt">IntPairPred</span><span class="o">,</span> <span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">Email</span><span class="o">)</span> <span class="k">=</span> <span class="n">pred</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">length</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>

<span class="c1">//to get a EmailFilter with a given IntPairPred, we can partially apply</span>
<span class="c1">//the size constraint with the given IntPairFred</span>
<span class="k">val</span> <span class="n">minimumSize</span><span class="k">:</span> <span class="o">(</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Email</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="n">ge</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>
<span class="k">val</span> <span class="n">maximumSize</span><span class="k">:</span> <span class="o">(</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Email</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="n">le</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>

<span class="c1">//or, given the size:</span>
<span class="k">val</span> <span class="n">constr20</span><span class="k">:</span> <span class="o">(</span><span class="kt">IntPairPred</span><span class="o">,</span> <span class="kt">Email</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="k">_:</span> <span class="kt">IntPairPred</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>
<span class="k">val</span> <span class="n">constr30</span><span class="k">:</span> <span class="o">(</span><span class="kt">IntPairPred</span><span class="o">,</span> <span class="kt">Email</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="k">_:</span> <span class="kt">IntPairPred</span><span class="o">,</span> <span class="mi">30</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>

<span class="c1">//then we can have the EmailFilters by further partial apply the above function.</span>
<span class="k">val</span> <span class="n">min20</span><span class="k">:</span> <span class="kt">EmailFilter</span> <span class="o">=</span> <span class="n">minimumSize</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>
<span class="k">val</span> <span class="n">max20</span><span class="k">:</span> <span class="kt">EmailFilter</span> <span class="o">=</span> <span class="n">maximumSize</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="k">_:</span> <span class="kt">Email</span><span class="o">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3">Curried Function</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Methods in Scala can have more than one parameter list.
</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">sizeConstraint</span><span class="o">(</span><span class="n">pred</span><span class="k">:</span> <span class="kt">IntPairPred</span><span class="o">)(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">email</span><span class="k">:</span> <span class="kt">Email</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
  <span class="n">pred</span><span class="o">(</span><span class="n">email</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">size</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span>
</pre></div>

<p>
And the type of it would be:
</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">sizeConstraintFn</span><span class="k">:</span> <span class="kt">IntPairPred</span> <span class="o">=&gt;</span> <span class="nc">Int</span> <span class="k">=&gt;</span> <span class="nc">Email</span> <span class="k">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraint</span>
</pre></div>

<p>
Such a chain of one-parameter functions is called a curried function.
With this curried function, we could more easily get the EmailFilter:
</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">min20</span><span class="k">:</span> <span class="kt">Email</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraintFn</span><span class="o">(</span><span class="n">ge</span><span class="o">)(</span><span class="mi">20</span><span class="o">)</span>
<span class="k">val</span> <span class="n">max20</span><span class="k">:</span> <span class="kt">Email</span> <span class="o">=&gt;</span> <span class="nc">Boolean</span> <span class="k">=</span> <span class="n">sizeConstraintFn</span><span class="o">(</span><span class="n">le</span><span class="o">)(</span><span class="mi">20</span><span class="o">)</span>
</pre></div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4">Currying existing functions</h3>
<div class="outline-text-3" id="text-1-4">
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">sum</span><span class="k">:</span> <span class="o">(</span><span class="kt">Int</span><span class="o">,</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span> <span class="k">_</span> <span class="o">+</span> <span class="k">_</span>
<span class="k">val</span> <span class="n">sumCurried</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="nc">Int</span> <span class="k">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span> <span class="n">sum</span><span class="o">.</span><span class="n">curried</span>

<span class="c1">// or</span>
<span class="k">def</span> <span class="n">sum</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
<span class="k">val</span> <span class="n">sum2</span><span class="k">:</span> <span class="o">(</span><span class="kt">Int</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="nc">Int</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Int</span> <span class="k">=</span> <span class="o">(</span><span class="n">sum</span> <span class="k">_</span><span class="o">).</span><span class="n">curried</span>
</pre></div>
<p>
To do the reverse, you could use <b>Function.uncurried</b>
</p>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5">Dependency Injection with Currying and partial function application</h3>
<div class="outline-text-3" id="text-1-5">
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">trait</span> <span class="nc">EmailRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">getMails</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">,</span> <span class="n">unread</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Email</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">FilterRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">getEmailFilter</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">EmailFilter</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">MailboxService</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">getNewMails</span><span class="o">(</span><span class="n">emailRepo</span><span class="k">:</span> <span class="kt">EmailRepository</span><span class="o">)(</span><span class="n">filterRepo</span><span class="k">:</span> <span class="kt">FilterRepository</span><span class="o">)(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span> <span class="k">=</span>
    <span class="n">emailRepo</span><span class="o">.</span><span class="n">getMails</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="n">filter</span><span class="o">(</span><span class="n">filterRepo</span><span class="o">.</span><span class="n">getEmailFilter</span><span class="o">(</span><span class="n">user</span><span class="o">))</span>
  <span class="k">val</span> <span class="n">newMails</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=&gt;</span> <span class="nc">Seq</span><span class="o">[</span><span class="kt">Email</span><span class="o">]</span>
<span class="o">}</span>
</pre></div>

<p>
We need an object that extends MailboxService. The idea is to
implement <code>newMails</code> by currying the <code>getNewMails</code> method and fixing it
with concrete implementations of the dependencies, <b>EmailRepository</b> and
<b>FilterRepository</b>:
</p>

<div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">MockEmailRepository</span> <span class="k">extends</span> <span class="nc">EmailRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">getMails</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">,</span> <span class="n">unread</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Email</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">MockFilterRepository</span> <span class="k">extends</span> <span class="nc">FilterRepository</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">getEmailFilter</span><span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">EmailFilter</span> <span class="o">=</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">true</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">MailboxServiceWithMockDeps</span> <span class="k">extends</span> <span class="nc">MailboxService</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">newMails</span><span class="k">:</span> <span class="o">(</span><span class="kt">User</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="nc">Seq</span><span class="o">[</span><span class="kt">Email</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">getNewMails</span><span class="o">(</span><span class="nc">MockEmailRepository</span><span class="o">)(</span><span class="nc">MockFilterRepository</span><span class="o">)</span> <span class="k">_</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Predef</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Variants of <b>assert</b> intended for use with static analysis tools are
also provided: <b>assume</b>, <b>require</b> and <b>ensuring</b>.
</li>
<li>require and ensuring are intended for use as a means of
<b>design-by-contract</b> style specification of <i>pre- and post-conditions</i>
on functions, with the intention that these specifications could be
consumed by a static analysis tool.
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">addNaturals</span><span class="o">(</span><span class="n">nats</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">require</span><span class="o">(</span><span class="n">nats</span> <span class="n">forall</span> <span class="o">(</span><span class="k">_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">),</span> <span class="s">"List contains negative numbers"</span><span class="o">)</span>
  <span class="n">nats</span><span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="mi">0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
<span class="o">}</span> <span class="n">ensuring</span><span class="o">(</span><span class="k">_</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span>
</pre></div>
<ul class="org-ul">
<li>
<b>require</b> is distinct from assert in that if the condition fails,
then the <i>caller of the function</i> is to blame rather than a <i>logical
error</i> having been made within function itself.
</li>
<li>
<b>ensuring</b> is a form of assert that declares the guarantee the
function is providing with regards to its return value.
</li>
</ul>
</li>
<li>
<code>def ??? : Nothing ~ : ~???</code> can be used for marking methods that
remain to be implemented.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Type System in Scala</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>
<code>Nothing</code> : is a <b>subtype</b> of every other type (including
<code>Scala.Null</code>); there exist no instances of this type.
<ul class="org-ul">
<li>value <code>scala.collection.immutable.Nil</code> is defined of type
<code>List[Nothing]</code>. Because List are <b>covariant</b> in Scala, this make
<code>scala.collection.immutable.Nil</code> an instance of <code>List[T]</code>, <i>for any
element of type <code>T</code></i>.
</li>
<li>Another usage for <code>Nothing</code> is the return type for methods which
<b>never</b> return normally. For example, the <code>error</code> method in in
<code>scala.sys</code> which always throws an exception.
</li>
</ul>
</li>
<li>
<code>Null</code> is a subtype of all *reference types*(<code>AnyRef</code>); its only
instance is the <code>null</code> reference. Since <code>Null</code> is not a subtype of <b>value
types</b>, <code>null</code> is not a member of any such type. For instance, it is
<i>not possible to assign <code>nul~l to a variable of type ~scala.Int</code></i>.
</li>
<li>
<code>Option</code>
<ul class="org-ul">
<li>The most idiomatic way to use an <code>Option</code> is to treat it as a
collection or monand and use <code>map</code>, <code>flatMap</code>, <code>filter</code>, or
<code>foreach</code>:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">request</span> <span class="n">getParameter</span> <span class="s">"name"</span>
<span class="k">val</span> <span class="n">upper</span> <span class="k">=</span> <span class="n">name</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">trim</span> <span class="o">}</span> <span class="n">filter</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">}</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">toUpperCase</span> <span class="o">}</span>
<span class="n">println</span><span class="o">(</span><span class="n">upper</span> <span class="n">getOrElse</span> <span class="s">""</span><span class="o">)</span>
</pre></div>
</li>
<li>Note that this is equivalent to:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">upper</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">name</span> <span class="k">&lt;-</span> <span class="n">request</span> <span class="n">getParameter</span> <span class="s">"name"</span>
  <span class="n">trimmed</span> <span class="k">&lt;-</span> <span class="nc">Some</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="n">trim</span><span class="o">)</span>
  <span class="n">upper</span> <span class="k">&lt;-</span> <span class="nc">Some</span><span class="o">(</span><span class="n">trimmed</span><span class="o">.</span><span class="n">toUpperCAse</span><span class="o">)</span> <span class="k">if</span> <span class="n">trimmed</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="o">}</span> <span class="n">yeild</span> <span class="n">upper</span>
</pre></div>
</li>
<li>the less-idiomatic way is via pattern matching:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">nameMaybe</span> <span class="k">=</span> <span class="n">request</span> <span class="n">getParameter</span> <span class="s">"name"</span>
<span class="n">nameMaybe</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">toUppercase</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">println</span> <span class="o">(</span><span class="s">"No name value"</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Using <code>fold[B](ifEmpty:=&gt;B)(f: (A)=&gt;B) : B</code>
returns the result of applying <code>f</code> to this Option's value if it is
nonempty, otherwise, evaluates expression <code>ifEmpty</code>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">Partial Function</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>
<code>PartialFunction[-A, +B] extends (A)=&gt;B</code> is a unary function where
the domain does not necessarily include all values of type A. The
function <code>isDefinedAt</code> allows to test dynamically if a value is in
the domain of the function:
</li>
<li>It is the responsibility of the caller to call isDefinedAt before
calling apply, because if isDefinedAt is false, it is not
guaranteed apply will throw an exception to indicate an error
condition.
</li>
<li>Example:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">sample</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span>
<span class="k">val</span> <span class="n">isEven</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">=&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="s">" is even"</span>
<span class="o">}</span>

<span class="c1">//the method collect can use isDefinedAt to select which members to collect</span>
<span class="k">val</span> <span class="n">eventNumbers</span> <span class="k">=</span> <span class="n">sample</span> <span class="n">collect</span> <span class="n">isEven</span>

<span class="k">val</span> <span class="n">isOld</span> <span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">]</span><span class="k">=</span> <span class="o">{</span>
  <span class="k">case</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="n">x</span> <span class="o">+</span> <span class="s">" is old"</span>
<span class="o">}</span>

<span class="c1">//the method orElse allows chaining of another partial function</span>
<span class="c1">//to handle input outside the declared domain.</span>
<span class="k">val</span> <span class="n">numbers</span> <span class="k">=</span> <span class="n">sample</span> <span class="n">map</span> <span class="o">(</span><span class="n">isEven</span> <span class="n">orElse</span> <span class="n">isOld</span><span class="o">)</span>
</pre></div>
</li>
<li>A block with bunch of <code>case</code> inside in one way of defining an
<b>partial functions</b>, as opposed to "total" functions:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">fraction</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PartialFunction</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">d</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="mi">42</span><span class="o">/</span><span class="n">d</span>
  <span class="k">def</span> <span class="n">isDefinedAt</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">d</span><span class="o">!=</span><span class="mi">0</span>
<span class="o">}</span>

<span class="c1">//this can also be defined as:</span>
<span class="k">val</span> <span class="n">fraction</span> <span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
  <span class="o">{</span> <span class="k">case</span> <span class="n">d</span><span class="k">:</span> <span class="kt">Int</span> <span class="kt">if</span> <span class="kt">d!=</span><span class="err">0</span> <span class="o">=&gt;</span> <span class="mi">42</span> <span class="o">/</span> <span class="n">d</span><span class="o">}</span>
</pre></div>
</li>
<li>The difference in behavior between <code>collect</code> and <code>man</code>, which is
that <code>clllect</code> expects a partial function, and automatically
filters out the values that are not in the function domain.
</li>
<li>In Scala any instance of <code>Seq</code> or <code>Map</code> (but not Set) is actually a
<b>partial function</b> so that its domain lies inside the Seq's length
or Map's key set.
</li>
<li>
<b>PartialFunction</b> trait supports the <code>lift</code> method, which converts
the partial function to a normal function that doesn't crash by
return the result as an Option.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Scala collections topic</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>List vs Array
<ul class="org-ul">
<li>Array is mutable, meaning you can change the values of each
index. An immutable analog of <code>Array</code> is <code>IndexedSeq</code>
</li>
<li>List is immutable, and a new list is created everytime you do a modification.
</li>
<li>
<code>Array[A]</code> is literally a Java array, a <code>List[A]</code> is an immutable data
structure that is either <code>Nil</code> or consists of a pair <code>(A, List[A])</code>.
</li>
</ul>
</li>
<li>Ways to iterate through a collection: <code>fold</code>, <code>reduce</code>, <code>scan</code>
<ul class="org-ul">
<li>
<code>fold[A1 &gt;: A]: (z: A1)(op: (A1, A1) =&gt; A1 ): A1</code> : takes a initial
seed value and then operate on the sequence.
<ul class="org-ul">
<li>
<code>foldLeft[B](z: B)(op: (B, A) =&gt; B): B</code> and <code>foldRight</code> can have
a different return type than the sequence element type.
</li>
</ul>
</li>
<li>
<code>scan</code>: works like <code>fold</code> but return a sequence instead of final value.
</li>
<li>
<code>reduce[A1 &gt;: A](op: (A1, A1) =&gt; A1) : A1</code> : takes no initial
seed, but just an binary operator.
</li>
</ul>
</li>
<li>Trait <code>Traversable</code>: it is the <b>top</b> of the collection
hierarchy. All its operations are guarantee to be performed in a
<b>single-threaded</b> manner.
<ul class="org-ul">
<li>
<code>collect</code> : The collection obtained from applying the partial
function <code>f</code> to every element in xs for which it is defined and
collecting the results.
</li>
<li>String operations <code>mkString</code>, <code>addString</code>, <code>stringPrefix</code>, which give
alternative ways of converting a collection to a string.
</li>
</ul>
</li>
<li>
<code>Stream</code> is like <code>List</code>, except that its elements are computed
lazily. Because Stream elements are computed lazily, a <code>Stream</code> can
be infinitely long.
<ul class="org-ul">
<li>
<code>Stream</code> can be constructed with the <code>#::</code> method:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">stream</span> <span class="k">=</span> <span class="mi">1</span>  <span class="o">#::</span> <span class="mi">2</span>  <span class="o">#::</span> <span class="mi">3</span>  <span class="o">#::</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">emtpy</span>
<span class="k">val</span> <span class="n">stream2</span> <span class="k">=</span> <span class="o">(</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">10000000</span> <span class="o">).</span><span class="n">toStream</span>
</pre></div>
</li>
<li>Be careful with methods that arent transformers. Calls to the
strict methods are evaluated immediately and can easily cause OutOfMemory:
<ul class="org-ul">
<li>
<code>stream.max</code>
</li>
<li>
<code>stream.size</code>
</li>
<li>
<code>stream.sum</code>
</li>
</ul>
</li>
</ul>
</li>
<li>Sorting a sequential collection
<ul class="org-ul">
<li>Sorting methods defined on
<dl class="org-dl">
<dt> <code>sorted()</code> </dt>
<dd>sort the list using the natural ordering, based on
the implicit Ordering passed.
</dd>
<dt> <code>sortBy()</code> </dt>
<dd>sort by a given attribute using the attribute's
type. <code>personList.sortBy(_.age)</code>
</dd>
<dt> <code>sortWith()</code> </dt>
<dd>Takes a comparator function.
</dd>
</dl>
</li>
<li>Mix in the <b>Ordered</b> trait, and implement a <code>compare</code> method,
giving the type a <b>single way</b> to order itself.
</li>
<li>Trait <b>Ordering</b>'s instance represent a <b>strategy</b> for sorting
instance of a type.
</li>
<li>
<code>scala.util.Sorting.quickSort</code> sort Array in place:
<div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">AgeOrdering</span> <span class="k">extends</span> <span class="nc">Ordering</span><span class="o">[</span><span class="kt">Person</span><span class="o">]{</span>
    <span class="k">def</span> <span class="n">compare</span> <span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Person</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Person</span><span class="o">)</span> <span class="k">=</span> <span class="n">a</span><span class="o">.</span><span class="n">age</span> <span class="n">compare</span> <span class="n">b</span><span class="o">.</span><span class="n">age</span>
<span class="o">}</span>
<span class="nc">Sorting</span><span class="o">.</span><span class="n">quickSort</span><span class="o">(</span><span class="n">people</span><span class="o">)(</span><span class="nc">AgeOrdering</span><span class="o">)</span>
</pre></div>
</li>
<li>
<b>Ordering</b> and <b>Ordered</b> both provide the same functionality, but
in different way.
</li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Core Library</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1">Strings</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>object equality test with <code>==</code> method, which is defined on
<code>AnyRef</code>. It will check for <code>null</code> values for you before calling
<code>equals</code> method. You don't have to check for <code>null</code> when comparing
</li>
<li>String <b>interpolation</b>, precede string with the letter <code>s</code> <br>
  ~s"$name is $age years old"~ <br><ul class="org-ul">
<li>This creates a <b>processed</b> string literal. and <code>s</code> is actually a
method.
</li>
<li>
<code>f</code> string interpolator using printf style formatting. <br>
    ~f"$name weights $weight%.2f pounds"
</li>
<li>
<code>raw</code> string interpolator performs no escaping of literlas within
the string.
</li>
</ul>
</li>
<li>
</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Monoid</h2>
<div class="outline-text-2" id="text-7">
<p>
Monoid is an <b>algebric structure</b>. Given a type <code>T</code>, a binary operation
<code>Op:(T,T) =&gt; T</code>, and an instance <code>Zero: T</code>, with the properties that
will be specified below, the triple <code>(T, Op, Zero)</code> is called a
<b>monoid</b>. Here are the properties:
</p>
<dl class="org-dl">
<dt> Neutral element </dt>
<dd>
<code>Zero Op a == a Op Zero == a</code>
</dd>
<dt> Associativity </dt>
<dd>
<code>(a Op b) Op c == a Op (b Op c)</code>
</dd>
</dl>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Mappings Between Monoids</h3>
<div class="outline-text-3" id="text-7-1">
<p>
For two monoids, <code>(A, OpA, ZeroA)</code> and <code>(B, OpB, ZeroB)</code>, we define a
<b>mapping</b> from one monoid to another as a function: <code>f: A =&gt; B</code>, such
that:
</p>
<ul class="org-ul">
<li>
<code>f(ZeroA) = ZeroB</code>
</li>
<li>
<code>f(x OpA y)</code> = <code>f(x) OpB f(y)</code>
</li>
</ul>
<p>
**In Scala
To define a monoid in Scala, we declare the following
</p>
<div class="highlight"><pre><span></span>trait Monoid[T] {
 def Zero: T
 def op: (T,T) =&gt; T
}
</pre></div>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">Monoids Composition</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>Monoids <b>compose well</b>; for example a tuple of monoids is itself a
monoid, as such its simple to define a monoid for a complex type
once monoids for its constituents types exists.
</li>
<li>Given a Monoid of <code>A</code>, we can have a Monoid for <code>Option[A]</code>:
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">def</span> <span class="n">optionMonoid</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">implicit</span> <span class="n">am</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">Monoid</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">id</span> <span class="k">=</span> <span class="nc">None</span>
    <span class="k">def</span> <span class="n">op</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="k">match</span><span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">x</span>
      <span class="k">case</span> <span class="o">(</span><span class="nc">None</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">y</span>
      <span class="k">case</span> <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">y</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">am</span><span class="o">.</span><span class="n">op</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
</li>
<li>Given a Monoid of <code>B</code>, we can have a Monoid for <b>functions</b> return <code>B</code>.
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">def</span> <span class="n">functionMonoid</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="k">implicit</span> <span class="n">bm</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">A</span> <span class="k">=&gt;</span> <span class="kt">B</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">Monoid</span><span class="o">[(</span><span class="kt">A</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">id</span> <span class="k">=</span> <span class="n">A</span><span class="k">=&gt;</span><span class="n">bm</span><span class="o">.</span><span class="n">id</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">op</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
      <span class="n">a</span> <span class="k">=&gt;</span> <span class="n">bm</span><span class="o">.</span><span class="n">op</span><span class="o">(</span><span class="n">x</span><span class="o">(</span><span class="n">a</span><span class="o">),</span> <span class="n">y</span><span class="o">(</span><span class="n">a</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>
</li>
<li>To collaspe a bunch of values using Monoid:
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">def</span> <span class="n">fold</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">la</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">am</span><span class="k">:</span> <span class="kt">Monoid</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">:</span> <span class="kt">A</span> <span class="o">=</span>
<span class="n">la</span><span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">am</span><span class="o">.</span><span class="n">id</span><span class="o">)(</span><span class="n">am</span><span class="o">.</span><span class="n">op</span><span class="o">)</span>
</pre></div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">Monad in Scala</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>Monad can be think of as <b>Wrappers</b>, taking a object and wrap it
with a monad.
</li>
<li>Monad provides us with two operations:
<dl class="org-dl">
<dt> identity </dt>
<dd>
<code>unit</code> in Scala
</dd>
<dt> bind </dt>
<dd>
<code>flatMap</code> in Scala
</dd>
</dl>
</li>
<li>Scala doesn't provide Monad type build-in, to model Monad:
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">Monad</span><span class="o">[</span><span class="kt">A</span><span class="o">]{</span>
  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span><span class="o">=&gt;</span><span class="nc">Monad</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Monad</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
<span class="o">}</span>
<span class="k">def</span> <span class="n">unit</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Monad</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</pre></div>
</li>
<li>
<code>unit</code> simply performs the wrapping part: given a value of type <code>A</code>,
it will return a value of type <code>Monad[A]</code>
</li>
<li>Although scala doesn't have a Monad type, but that doesn't mean
there are no monads in Scala. Monad is not a class or a trait; it is
a concept. Every <b>wrapper</b> that provides us with the two operations
is essentially a monad.
</li>
<li>For a monand, it should follow:
<dl class="org-dl">
<dt> left-identity law </dt>
<dd>
<code>unit(x).flatMap(f) == f(x)</code>
</dd>
<dt> right-identity law </dt>
<dd>
<code>m.flatMap(unit) == m</code>
</dd>
<dt> associatity law </dt>
<dd>
<code>m.flatMap(f).flatMap(g) == m.flatMap( x=&gt;
       f(x).flatMap(g))</code>
</dd>
</dl>
</li>
<li>Some examples:
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">User</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">child</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">UserService</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">loadUser</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{...}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">getChild</span> <span class="k">=</span> <span class="o">(</span><span class="n">user</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">child</span>

<span class="c1">//load a user from the service and get its grandchild.</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">UserService</span><span class="o">.</span><span class="n">loadUser</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span>
  <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">getChild</span><span class="o">)</span>
  <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">getChild</span><span class="o">)</span>

<span class="c1">//for-comprehension is basically syntax sugar for mapping</span>
<span class="c1">//flatMapping and filtering.</span>
<span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
  <span class="n">user</span> <span class="k">&lt;-</span> <span class="nc">UserService</span><span class="o">.</span><span class="n">loadUser</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span>
  <span class="n">userChild</span> <span class="k">&lt;-</span> <span class="n">user</span><span class="o">.</span><span class="n">child</span>
  <span class="n">userGrandChild</span> <span class="k">&lt;-</span> <span class="n">userChild</span><span class="o">.</span><span class="n">child</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">userGrandChild</span>
</pre></div>
</li>
<li>
<b>Future</b> also defines <code>flatMap</code>, which can be chained in a similar
way as in the above code.
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><a href="file:///Users/wudong/Dropbox/ebooks/langs/scala/Scala%20Cookbook%20(2013).pdf">Scala Cookbook</a></h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">Scala package</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>Put common code in package object. to make functions, fields, and
other code available at a <b>package</b> level, without requiring a class
or object.
<ul class="org-ul">
<li>put the code in a file named <b>package.scala</b>
</li>
<li>using <code>package object model {}</code>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">How for loops are translated</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li>A simple <code>for</code> loop that iterates over a collection is translated to
a <code>foreach</code> method call on the collection
</li>
<li>A <code>for</code> loop with a <b>guard</b> is translated to a sequence of a
<code>withFilter</code> method call on the collection followed by a <code>foreach</code> call.
</li>
<li>A <code>for</code> loop with a <code>yield</code> expression is translated to a <code>map</code>
  method call on the collection.
</li>
<li>A <code>for</code> loop with a <code>yield</code> expression and a guard is translated to
a <code>withFilter</code> method call on the collection, followed by a <code>map</code>
method call.
</li>
<li>Using <code>scalac -Xprint:parse Main.scala</code> can be used to demonstrate
the translation.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">Control structures</h3>
<div class="outline-text-3" id="text-9-3">
</div>
<div id="outline-container-sec-9-3-1" class="outline-4">
<h4 id="sec-9-3-1">Break and Continue</h4>
<div class="outline-text-4" id="text-9-3-1">
<ul class="org-ul">
<li>Scala doesn't have <code>break</code> and <code>continue</code> keywords. Similar
functionality can be implemented through <code>scala.util.control.Breaks</code>
</li>
<li>Example:
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">util.control.Breaks._</span>

<span class="n">breakable</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="o">)</span> <span class="n">break</span> <span class="c1">// break out of the for loop</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="n">until</span> <span class="n">searchMe</span><span class="o">.</span><span class="n">length</span><span class="o">){</span>
  <span class="n">breakable</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">searchFound</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">break</span> <span class="c1">// break out the breakable, continue outside loop.</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</li>
<li>
<code>break</code> essentially raise an exception which will be catch by the
<code>breakable</code>, both of this are methods defined in
<code>scala.util.control.Breaks</code>:
<div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">val</span> <span class="n">breakException</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">BreakControl</span>
<span class="k">def</span> <span class="n">break</span><span class="o">()</span> <span class="k">:</span> <span class="kt">Nothing</span> <span class="o">=</span> <span class="o">{</span> <span class="k">throw</span> <span class="n">breakException</span><span class="o">}</span>
<span class="k">def</span> <span class="n">breakable</span> <span class="o">(</span><span class="n">op</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">){</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">op</span>
  <span class="o">}</span><span class="k">catch</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">BreakControl</span> <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="n">ne</span> <span class="n">breakException</span><span class="o">)</span> <span class="k">throw</span> <span class="n">ex</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Nested loops and labeled breaks
<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.util.control._</span>

<span class="k">val</span> <span class="nc">Inner</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Breaks</span>
<span class="k">val</span> <span class="nc">Outer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Breaks</span>
<span class="nc">Outer</span><span class="o">.</span><span class="n">breakable</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Inner</span><span class="o">.</span><span class="n">breakable</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">j</span> <span class="k">&lt;-</span> <span class="sc">'a'</span> <span class="n">to</span> <span class="sc">'e'</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">==</span> <span class="sc">'c'</span><span class="o">)</span> <span class="nc">Inner</span><span class="o">.</span><span class="n">break</span> <span class="k">else</span> <span class="n">println</span> <span class="o">(</span><span class="s">s"i: </span><span class="si">$i</span><span class="s">, j : </span><span class="si">$j</span><span class="s">"</span><span class="o">)</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">j</span> <span class="o">==</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">==</span> <span class="sc">'b'</span><span class="o">)</span> <span class="nc">Outer</span><span class="o">.</span><span class="n">break</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-3-2" class="outline-4">
<h4 id="sec-9-3-2">Switch and Match</h4>
<div class="outline-text-4" id="text-9-3-2">
<ul class="org-ul">
<li>Use Scala match expression like a Java <code>switch</code> statement.
</li>
<li>
<code>@switch</code> annotation provides a warning at compile time if the
switch can't compiled to a <b>tableswitch</b> or <b>lookupswitch</b>, which is
better for performance, because it results in a branch table rather
than a decision tree.
</li>
<li>One case statement can match multiple conditions:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">i</span> <span class="k">=</span> <span class="mi">5</span>
<span class="n">i</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">5</span> <span class="o">|</span> <span class="mi">7</span> <span class="o">|</span> <span class="mi">9</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"old"</span><span class="o">)</span>
  <span class="k">case</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">6</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">|</span> <span class="mi">10</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"old"</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
<p>
This same syntax works with strings and other types.
</p>
</li>
<li>Accessing the value of the default case in match:
<div class="highlight"><pre><span></span><span class="n">i</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"1"</span><span class="o">)</span>
  <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"2"</span><span class="o">)</span>
  <span class="k">case</span> <span class="n">others</span> <span class="k">=&gt;</span> <span class="n">println</span> <span class="o">(</span><span class="s">"you give me : "</span><span class="o">+</span> <span class="n">others</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>Instead of using a <code>_</code> <b>wildcard</b> character, assign a variable name to
the default case.
</li>
<li>It is important to provide a default match, otherwise a
<b>MatchError</b> will be raised.
</li>
</ul>
</li>
<li>Sequence patterns in match:
<div class="highlight"><pre><span></span><span class="n">x</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">List</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="s">"a three element list with 0 as the first element"</span>
  <span class="k">case</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">_</span><span class="o">*)</span> <span class="k">=&gt;</span> <span class="s">"a list begining with 1, having any number of elements"</span>
  <span class="k">case</span> <span class="nc">Vector</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">_</span><span class="o">*)</span> <span class="k">=&gt;</span> <span class="s">"a vector begining with 1, having any number of elements"</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Adding variable patterns, to assign the variable to the matched
pattern value:
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="s">s"it is a list: </span><span class="si">$list</span><span class="s">"</span>
<span class="c1">//or</span>
<span class="k">case</span> <span class="n">list</span> <span class="k">@</span> <span class="nc">List</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="k">_</span><span class="o">*)</span> <span class="k">=&gt;</span> <span class="s">s"also a list: </span><span class="si">$list</span><span class="s">"</span>
<span class="c1">//</span>
<span class="k">case</span> <span class="n">x</span> <span class="k">@</span> <span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="s">s"</span><span class="si">$x</span><span class="s">"</span>  <span class="c1">//same as below to get the value.</span>
<span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="s">s"</span><span class="si">$x</span><span class="s">"</span>
<span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="s">"got Some some"</span> <span class="c1">//work but can't access the Some</span>
</pre></div>
</li>
<li>Type parameter cannot be matched because of type erasure.
</li>
<li>List in a Match Expression:
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">listToString</span><span class="o">(</span><span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">list</span> <span class="k">match</span><span class="o">{</span>
  <span class="k">case</span> <span class="n">s</span> <span class="o">::</span> <span class="n">rest</span> <span class="k">=&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">listToString</span><span class="o">(</span><span class="n">rest</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="s">""</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>Don't forget to handle the <code>Nil</code> case, or you will get an MatchError
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-3-3" class="outline-4">
<h4 id="sec-9-3-3">Try and catch</h4>
<div class="outline-text-4" id="text-9-3-3">
<ul class="org-ul">
<li>Declaring a variable vefore using it:
<ul class="org-ul">
<li>In general, declare your field as an Option before the try/catch
block then create a Some inside the try clause.
</li>
<li>Forget about the existence of <code>null</code>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4">Class, Object and Trait</h3>
<div class="outline-text-3" id="text-9-4">
<ul class="org-ul">
<li>When to use an abstract class.
<ul class="org-ul">
<li>You want to create a base class that requires constructor
arguments. Traits don't allow constructor parameters.
</li>
<li>The code will be called from Java code.
</li>
</ul>
</li>
<li>Case class generates a <code>copy</code> method and can be used as:
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Employee</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">loc</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">role</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">val</span> <span class="n">fred</span> <span class="k">=</span> <span class="nc">Employee</span><span class="o">(</span><span class="s">"Fred"</span><span class="o">,</span> <span class="s">"Anchorage"</span><span class="o">,</span> <span class="s">"Salesman"</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joe</span> <span class="k">=</span> <span class="n">fred</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">"Joe"</span><span class="o">,</span> <span class="n">role</span><span class="o">=</span><span class="s">"Mechanic"</span><span class="o">)</span>
</pre></div>
</li>
<li>The concept of a "inner class" is different in Scala than in Java.
<ul class="org-ul">
<li>In Java, the inner classes are members of the enclosing <b>class</b>,
</li>
<li>In Scala, the inner classes are bound to the outer <b>object</b> instances.
</li>
</ul>
</li>
<li>Method scope is public by default, but can have:
<ul class="org-ul">
<li>Object-private scope
</li>
<li>Private
</li>
<li>Package
</li>
<li>Package-specific
</li>
<li>Protected
</li>
</ul>
</li>
<li>Tuples can be used in this way:
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">getStockInfo</span> <span class="k">=</span> <span class="o">(</span><span class="s">"NFLX"</span><span class="o">,</span> <span class="mf">100.00</span><span class="o">)</span>
<span class="k">val</span> <span class="o">(</span><span class="n">symbol</span><span class="o">,</span> <span class="n">currentPrice</span><span class="o">)</span> <span class="k">=</span> <span class="n">getStockInfo</span>
</pre></div>
</li>
<li>Method takes Variable-Argument fields, to take zeor or more parameters:
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">printAll</span><span class="o">(</span><span class="n">strings</span><span class="k">:</span> <span class="kt">String*</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">strings</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>use _* to adape a sequence
</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">fruits</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">"apple"</span><span class="o">,</span> <span class="s">"banana"</span><span class="o">)</span>
<span class="n">printAll</span><span class="o">(</span><span class="n">fruits</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
</pre></div>
</li>
<li>To declare a method can throw an exception, use the <code>@throws</code>
  annotation.
<div class="highlight"><pre><span></span><span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">IOException</span><span class="o">])</span>
<span class="nd">@throws</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Exception</span><span class="o">])</span>
<span class="k">def</span> <span class="n">play</span> <span class="o">{</span>
  <span class="c1">//exception throwing code here</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>The <code>@throws</code> is the Scala way of providing the throws method
signature to Java consumers.
</li>
<li>Whether the comsumers are using Scala or Java, it is a good
practise to declare the Exceptions you are throwing in the code.
</li>
</ul>
</li>
<li>If your class can be extended, specify <b>this.type</b> as the return
type of fluent style methods.
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">setFirstName</span><span class="o">(</span><span class="n">firstName</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">this.</span><span class="k">type</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">fname</span> <span class="k">=</span> <span class="n">firstName</span>
  <span class="k">this</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Import can be placed almost anywhere inside a program to limit the
scope of the import.
</li>
<li>It is possible to limit which classes can use a Trait by
inheritance:
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">StarfleetComponent</span>
<span class="k">trait</span> <span class="nc">WarpCore</span> <span class="k">extends</span> <span class="nc">StarfleetComponent</span>
</pre></div>
<ul class="org-ul">
<li>With the <code>extends</code> keyword, the Trait can only be mixed into
classes that extend the type.
</li>
<li>As long as a class, and a trait <b>share the same superclass</b>, the
code will compile.
</li>
</ul>
</li>
<li>Another way of the limiting:
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">MyTrait</span> <span class="o">{</span>
  <span class="k">this:</span> <span class="kt">BaseType</span> <span class="o">=&gt;</span>
<span class="o">}</span>
</pre></div>
<ul class="org-ul">
<li>This will make <code>MyTrait</code> can only be mixed into a class that is a
subclass of a type named <code>BaseType</code>.
</li>
<li>This is refered as <b>self type</b>
</li>
<li>It is also possbile to require multiple other types.
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">WarpCore</span> <span class="o">{</span>
  <span class="k">this:</span> <span class="kt">Starship</span> <span class="kt">with</span> <span class="kt">WarpCoreEjector</span> <span class="kt">with</span> <span class="kt">FireExtinguisher</span> <span class="o">=&gt;</span>
<span class="o">}</span>
</pre></div>
</li>
</ul>
</li>
<li>Similarily, you can allow a trait to be mixed into a type that has a
method(or multiple methods) with given signatures. This is known as
<b>structure type</b>
<div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">WarpCore</span> <span class="o">{</span>
  <span class="k">this:</span> <span class="o">{</span>
     <span class="kt">def</span> <span class="kt">ejectWarpCore</span><span class="o">(</span><span class="kt">password:</span> <span class="kt">String</span><span class="o">)</span> <span class="kt">:</span> <span class="kt">Boolean</span>
     <span class="kt">def</span> <span class="kt">startWarpCore:</span> <span class="kt">Unit</span>
  <span class="o">}</span> <span class="k">=&gt;</span>
<span class="o">}</span>
</pre></div>
</li>
<li>It is possbile to add trait to an object instance when the object is created.
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DavidBanner</span>
<span class="k">trait</span> <span class="nc">Angry</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">"you don't like me"</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">Test</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">hulk</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DavidBanner</span> <span class="k">with</span> <span class="nc">Angry</span>
<span class="o">}</span>
</pre></div>
</li>
</ul>
<p>
*
</p>
</div>
</div>

<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5">Functional Programming</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li>Function Literals:
<ul class="org-ul">
<li>Scala let you use the <code>_</code> wildcard instead of a variable name when
the parameter appears only once in your function.
</li>
<li>If a function literal consists of <b>one statement</b> that takes a
single argument, you need not explicitly name and specify the
argument.
</li>
<li>Examples:
<div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">foreach</span> <span class="o">(</span><span class="n">i</span><span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
<span class="c1">//same as</span>
<span class="n">x</span><span class="o">.</span><span class="n">foreach</span> <span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
<span class="c1">//save as</span>
<span class="n">x</span><span class="o">.</span><span class="n">foreach</span> <span class="o">(</span><span class="n">println</span><span class="o">)</span>
</pre></div>
</li>
</ul>
</li>
<li>Function variables and values.
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">double</span> <span class="k">=</span> <span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=&gt;</span>  <span class="o">{</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">}</span>
<span class="n">double</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="c1">// 4</span>
</pre></div>
<ul class="org-ul">
<li>The variable <code>double</code> is an instance of a function, known as a
<code>function value</code>.
</li>
<li>The functio instance can be called just like calling a method.
</li>
</ul>
</li>
<li>Using a method like an anonymous function:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">modFunction</span> <span class="k">:</span> <span class="kt">Int</span><span class="o">=&gt;</span><span class="nc">Boolean</span> <span class="k">=</span> <span class="n">i</span><span class="k">=&gt;</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
<span class="k">def</span> <span class="n">modMethod</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span><span class="mi">0</span>
<span class="n">list</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">modMethod</span><span class="o">)</span>
<span class="n">list</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">modFunction</span><span class="o">)</span>
</pre></div>
<ul class="org-ul">
<li>At a coding level, a <code>modMethod</code> is a <code>method</code> defined in a class.
</li>
<li>
<code>modFunction</code> is a <code>function</code> that's assigned to a variable, in
this case, it is an instance of the <code>Function1 trait</code>.
</li>
<li>Assign an existing function/method to a function variable.
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span> <span class="k">_</span>
<span class="c1">//or</span>
<span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>
<span class="c1">// c: Double =&gt; Double = &lt;function1&gt;</span>
<span class="n">c</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="c1">// 1.0</span>
<span class="c1">//causing error, not assignable.</span>
<span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span>
</pre></div>
<ul class="org-ul">
<li>This is called a partially applied function.
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6">Collections</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li>
<code>Traversable</code> trait lets you traverse an entire collection in terms
of a <code>foreach</code> method.
</li>
<li>
<code>Iterable</code> trait defines an <code>iterator</code>, which lets you loop through
a collection's element one at a time.
<ul class="org-ul">
<li>When using an iterator, the collection can be traversed only once,
beacuse each element is consumed during the iteration process.
</li>
</ul>
</li>
<li>
<code>Seq</code>
<ul class="org-ul">
<li>
<code>IndexedSeq</code>: indicates the random access of elements is efficent.
<ul class="org-ul">
<li>By default, specifying that you want an IndexedSeq, a <code>Vector</code>
      is created.
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="nc">IndexedSeq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
<span class="c1">//x : IndexedSeq[Int] = Vector(1,2,3)</span>
</pre></div>
</li>
<li>Implementation includes:
<ul class="org-ul">
<li>
<code>StringBuilder</code>, <code>String</code>
</li>
<li>
<code>Range</code>, <code>Vector</code>
</li>
<li>
<code>Array</code>: backed by a Java array, its elements are mutable, but
it can't change in size.
</li>
<li>
<code>ArrayBuffer</code>, mutable.
</li>
</ul>
</li>
</ul>
</li>
<li>
<code>LinearSeq</code>: implied that the collection can be efficiently split
into <code>head</code> and <code>tail</code> components.
<ul class="org-ul">
<li>Creating a <code>LinearSeq</code> creates a <code>List</code>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="nc">LinearSeq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
<span class="c1">//x : LinearSeq[Int] = List(1,2,3)</span>
</pre></div>
</li>
<li>Implementation includes:
<ul class="org-ul">
<li>
<code>List</code>, <code>LinkedList</code>, <code>MutableList</code>
</li>
<li>
<code>Queue</code>, <code>Stack</code>, <code>Stream</code>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<code>Buffer</code> is are mutable <code>Seq</code>
<ul class="org-ul">
<li>Implemented by <code>ArrayBuffer</code>, <code>ListBuffer</code>.
</li>
</ul>
</li>
<li>Scala's general purpose sequential collections:
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left"></th>
<th scope="col" class="left">Immutable</th>
<th scope="col" class="left">Mutable</th>
</tr></thead>
<tbody>
<tr>
<td class="left">Indexed</td>
<td class="left">Vector</td>
<td class="left">ArrayBuffer</td>
</tr>
<tr>
<td class="left">Linear</td>
<td class="left">List</td>
<td class="left">ListBuffer</td>
</tr>
</tbody>
</table>
</li>
<li>
<code>Map</code>:
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="left">
<col class="left">
<col class="left">
<col class="left">
</colgroup>
<thead><tr>
<th scope="col" class="left"></th>
<th scope="col" class="left">Immutable</th>
<th scope="col" class="left">Mutable</th>
<th scope="col" class="left">Descripton</th>
</tr></thead>
<tbody>
<tr>
<td class="left">HashMap</td>
<td class="left">Y</td>
<td class="left">Y</td>
<td class="left"></td>
</tr>
<tr>
<td class="left">LinkedHashMap</td>
<td class="left"></td>
<td class="left">Y</td>
<td class="left">elements returned by the order of insertation</td>
</tr>
<tr>
<td class="left">ListMap</td>
<td class="left">Y</td>
<td class="left">Y</td>
<td class="left">map implemented using a list</td>
</tr>
<tr>
<td class="left">Map</td>
<td class="left">Y</td>
<td class="left">Y</td>
<td class="left">The base map trait.</td>
</tr>
<tr>
<td class="left">SortedMap</td>
<td class="left">Y</td>
<td class="left"></td>
<td class="left">base trait</td>
</tr>
<tr>
<td class="left">TreeMap</td>
<td class="left">Y</td>
<td class="left"></td>
<td class="left">a red-black tree implmentation.</td>
</tr>
<tr>
<td class="left">WeakHashMap</td>
<td class="left"></td>
<td class="left">Y</td>
<td class="left"></td>
</tr>
</tbody>
</table>
</li>
<li>
<code>Set</code>
</li>
<li>
<code>Enumeration</code> : A finite collection of constant values.
</li>
<li>
<code>Iterator</code> : isn't a collection but gives a way to access the
elements in a collection.
<ul class="org-ul">
<li>defined many methods in a normal collection class.
</li>
<li>can convert an iterator to a collection when needed.
</li>
</ul>
</li>
<li>Strict and lazy collections
<ul class="org-ul">
<li>A <b>transformer method</b> is a method that constructs a new
collection from an existing collection.
<ul class="org-ul">
<li>map, filter, reverse, etc.
</li>
</ul>
</li>
<li>In a <code>strict</code> collection, memory for the elements is allocated
immediately, and all of its elements are immediately evaluated
when a transformer method is invoked.
</li>
<li>In a <code>lazy</code> collection, memory for the elements is not allocated
immediately, and transformer methods do not construct new elements
until they are demanded.
</li>
<li>All of the collection classes except <code>Stream</code> are strict.
</li>
<li>Other collection classes can be converted to a lazy collection by
creating a <code>view</code> on the collection.
</li>
</ul>
</li>
</ul>
</div>

<div id="outline-container-sec-9-6-1" class="outline-4">
<h4 id="sec-9-6-1">Seq implementation: Vector and ArrayBuffer</h4>
<div class="outline-text-4" id="text-9-6-1">
<ul class="org-ul">
<li>Make <code>Vector</code> the "Go to" Immutable sequence: fast, general-purpose,
immutable, sequential collection type.
</li>
<li>Make <code>ArrayBuffer</code> the "Go to" Mutable sequence.
</li>
<li>Use <code>ListBuffer</code> if you need a mutable sequential collection that
works more like a List, i.e., a linear sequence rather than an
indexed sequence).
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-6-2" class="outline-4">
<h4 id="sec-9-6-2">Loop counters</h4>
<div class="outline-text-4" id="text-9-6-2">
<ul class="org-ul">
<li>Using <code>zipWithIndex</code> or <code>zip</code> to create Loop counters.
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">days</span> <span class="k">=</span> <span class="nc">Arrays</span><span class="o">(</span><span class="s">"Sunday"</span><span class="o">,</span> <span class="s">"Monday"</span><span class="o">,</span> <span class="s">"Tuesday"</span><span class="o">,</span> <span class="s">"Wednesday"</span><span class="o">,</span>
  <span class="s">"Thursday"</span><span class="o">,</span> <span class="s">"Friday"</span><span class="o">,</span> <span class="s">"Saturday"</span><span class="o">)</span>
<span class="n">days</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
  <span class="k">case</span> <span class="o">(</span><span class="n">day</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"$count is $day"</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</li>
<li>When using <code>zipWithIndex</code>, the counter always starts at 0.
</li>
<li>Can also use <code>zip</code> method with a <code>Stream</code> to create a counter with a
starting value:
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="o">((</span><span class="n">day</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="k">&lt;-</span> <span class="n">days</span><span class="o">.</span><span class="n">zip</span><span class="o">(</span><span class="nc">Stream</span> <span class="n">from</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">s"day </span><span class="si">$count</span><span class="s"> is </span><span class="si">$day</span><span class="s">"</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-6-3" class="outline-4">
<h4 id="sec-9-6-3">Iterators</h4>
<div class="outline-text-4" id="text-9-6-3">
<ul class="org-ul">
<li>An iterator isn't a collection; instead, it gives you a way to
access the elements in a collection, one by one.
<ul class="org-ul">
<li>
<code>next()</code> : throw <code>NoSuchElementException</code> when no more element.
</li>
<li>
<code>hasNext()</code>
</li>
</ul>
</li>
<li>An important part of using an iterator is knowing that it is
<b>exhausted</b> after you use it.
</li>
<li>As you access each element, you <b>mutate</b> the iterator, and the
previous element is discarded.
</li>
<li>Can convert to a collection when needed:
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">it</span> <span class="k">=</span> <span class="nc">Iterator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span>
<span class="n">it</span><span class="o">.</span><span class="n">toArray</span>
</pre></div>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-6-4" class="outline-4">
<h4 id="sec-9-6-4">Splitting sequences into subset</h4>
<div class="outline-text-4" id="text-9-6-4">
<ul class="org-ul">
<li>
<code>groupBy</code> create a Map
</li>
<li>
<code>partition</code>
</li>
<li>
<code>span(p)</code> : the longest prefix whose elements satisfy <code>p</code>
</li>
<li>
<code>splitAt(i: Int)</code>
</li>
<li>
<code>sliding(size, step)</code> : works by passing a "sliding window" over the
original sequence, returning the sequence of a length given by
<code>size</code>. The <code>step</code> lets you skip over elements.
</li>
<li>
<code>unzip</code> is a handy companion to partition.
<ul class="org-ul">
<li>Partition divides a traversable into two traversables by a boolean predicate.
</li>
<li>Unzip divides a traversable into two by dividing each element into
two parts (each becomes an element in one traversable).
</li>
<li>If an element is a Tuple2 then each tuple is divided into two
otherwise a function is required to divide an element into two.
</li>
<li>Example:
<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Item</span><span class="o">(</span><span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="nc">List</span><span class="o">(</span><span class="nc">Item</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"bac"</span><span class="o">),</span> <span class="nc">Item</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"bla"</span><span class="o">),</span> <span class="nc">Item</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"bbb"</span><span class="o">)).</span><span class="n">unzip</span> <span class="o">{</span>
  <span class="n">item</span><span class="k">=&gt;</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="n">size</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-6-5" class="outline-4">
<h4 id="sec-9-6-5">
<span class="todo TODO">TODO</span> 10.22. Merging Collections sequential</h4>
</div>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><a href="https://www.youtube.com/watch?v=Oij5V7LQJsA">What to leave implicit</a></h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>Traditional ways to express context
<ul class="org-ul">
<li>Globals, rigid if immutable, unsave if mutable.
</li>
<li>Monkey patching ??
</li>
<li>Dependency injection, at runtime (Srping, Guice), or with macros
(MacWire, Scala framework).
</li>
<li>Cake pattern, close coupling + recursion.
</li>
</ul>
</li>
<li>Functional Way: parameterize all the things
<ul class="org-ul">
<li>No side effect
</li>
<li>type safe
</li>
<li>fine-grained control
</li>
<li>However:
<ul class="org-ul">
<li>sea of parameters,
</li>
<li>most of which hardly ever change
</li>
<li>repetitive, boring, prone to mistakes
</li>
</ul>
</li>
</ul>
</li>
<li>Implicits to help with the problems.
<ul class="org-ul">
<li>if there is one feature that makes Scala "Scala", it is implicit.
</li>
</ul>
</li>
<li>Implicits ground rules:
<ul class="org-ul">
<li>If you do not give an argument to an implicit parameter, one will
be provided by the compiler.
</li>
<li>Eligible are all implicit values that are <b>visible</b> at the point
of call.
</li>
<li>If there are more than one eligible candidate, the most specific
one is chosen.
</li>
<li>If there is no unique most specific candidate, an *ambiguity
error~ is reported by compiler.
</li>
</ul>
</li>
<li>Implicit conversions
</li>
<li>Implicit classes: shorthand for defining a new class and an implicit
conversion into it.
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">class</span> <span class="nc">C</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">{...}</span>
<span class="c1">//is expands to a implicit conversion from T to C</span>
<span class="k">class</span> <span class="nc">C</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="o">{...}</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">C</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="n">C</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
</pre></div>
</li>
<li>Implicits leverage what the compiler know about your code.
<ul class="org-ul">
<li>remove repetition and boilerplate.
</li>
<li>can hurt readability if taken too far.
</li>
</ul>
</li>
<li>Implicits Patterns
<ul class="org-ul">
<li>Extension methods: adding new methods to existing type.
</li>
<li>
<b>Late Trait Implementation</b>, making existing classes implement new
traits without changing their code. <i>It was the original reason
for implicits in Scala</i>.
<div class="highlight"><pre><span></span><span class="k">implicit</span> <span class="k">class</span> <span class="nc">StringDeco</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Ordered</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">other</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="o">???</span>
<span class="o">}</span>
</pre></div>
</li>
<li>Implicit parameters: close the type as far as we can, using type
safety to have finer grain control.
<ul class="org-ul">
<li>establish context
<ul class="org-ul">
<li>security checking with the current user
</li>
<li>set configurations
</li>
<li>inject dependencies
</li>
</ul>
</li>
<li>model capabilities
</li>
<li>implement type classes
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>
Ref <a href="https://jazzy.id.au/2015/03/03/sbt-task-engine.html">https://jazzy.id.au/2015/03/03/sbt-task-engine.html</a>
</p>
</div>
</div>


<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">SBT</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1">SBT as a Task Engine</h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>SBT is a task engine.
<ul class="org-ul">
<li>A task may be dependent on other tasks
</li>
<li>Any task from any point in the build may be redifined.
</li>
<li>New tasks can be easily added.
</li>
<li>Similar to <b>make</b> and <b>ant</b>
</li>
</ul>
</li>
<li>SBT tasks produce an output value, and are able to consume the
output value of the tasks they depend on.
<ul class="org-ul">
<li>whereas <b>make</b> and <b>ant</b> just modify the file system.
</li>
</ul>
</li>
<li>
<code>inspect</code> command let you inspect a task. An example :
<p class="verse">
&gt; inspect sources<br>
[info] Task: scala.collection.Seq[java.io.File]<br>
[info] Description:<br>
[info]  All sources, both managed and unmanaged.<br>
[info] Provided by:<br>
[info]  {<a href="file:///Users/jroper/sbt-fun/%7Dsbt-fun/compile:sources">file:///Users/jroper/sbt-fun/}sbt-fun/compile:sources</a><br>
[info] Defined at:<br>
[info]  (sbt.Defaults) Defaults.scala:188<br>
[info] Dependencies:<br>
[info]  compile:unmanagedSources<br>
[info]  compile:managedSources<br>
[info] Delegates:<br>
[info]  compile:sources<br>
[info]  *:sources<br>
[info]  {.}/compile:sources<br>
[info]  {.}/*:sources<br>
[info]  <b><i>compile:sources<br>
[info]  *</i></b>:sources<br>
[info] Related:<br>
[info]  test:sources<br></p>
<ul class="org-ul">
<li>
<code>Task: scala.collection.Seq[java.io.File]</code> : it is a task that
produces a sequence of files.
</li>
<li>
<code>inspect tree sources</code> to inspect the whole tree of tasks.
</li>
</ul>
</li>
<li>
<code>Setting</code> is a special kind of task
<p class="verse">
compile:scalaSource = src/main/scala<br></p>
<ul class="org-ul">
<li>
<code>Setting</code> get executed once per <b>session</b>, when sbt is started.
</li>
<li>
<code>Task</code> get executed once per <b>execution</b>.
</li>
<li>
<code>Setting</code> can only depend on other settings, not <code>Task</code>.
</li>
<li>In general, they can be considered the same thing. <code>Setting</code> are
just small optimization so that they don't have to be executed
every time.
</li>
</ul>
</li>
<li>A task can be scoped, by <code>configuration</code>, <code>project</code> and <code>task</code>.
<ul class="org-ul">
<li>When a task depends on another task, it can depend on that task in
a particular scope.
</li>
<li>The two main configuration scope are <code>comiple</code> and <code>test</code>.
</li>
<li>
<code>sources</code> depends on <code>compile:managedSources</code>, it means it depends
on <code>managedSources</code> in the <code>compile</code> scope.
</li>
<li>When you don't specify a scope, sbt will choose a default scope.
</li>
<li>We could do <code>inspect tree test:sources</code> to inspect the task in the
specific scope.
</li>
<li>If the scope is <code>*</code>, it means it is an <b>unscoped</b> task/setting.
</li>
<li>As a sbt build can have multiple project, and each project can
have its own set of settings. The tasks can be further scoped by
the project name.
<ul class="org-ul">
<li>For example <code>sbt-fun/compile:surces</code> is the task in the
<code>compile</code> scope from the <code>sbt-fun</code> project.
</li>
<li>
<code>*/*/:excludeFilter</code> is a <b>global</b> or for the entire build, with
no configuration scope, and no project scope.
</li>
</ul>
</li>
<li>Task can also be scoped by another task: same task key can be used
and explicitly configured for many tasks.
<ul class="org-ul">
<li>syntax: <code>unmanagedSources::includeFilter</code>, means the task
<code>includeFilter</code> is scoped to the <code>unmanagedSources</code> task.z
</li>
</ul>
</li>
</ul>
</li>
<li>Scope fallback: When a task declares a dependency, sbt will try and
satisfy that dependency with the <b>most specific</b> task it has for it,
but
<ul class="org-ul">
<li>if no task is defined at that specific scope, it will fallback
to a <b>less specific</b> scope.
</li>
<li>The general approach that sbt takes in its predefined task
dependency trees is to
<ul class="org-ul">
<li>depend on tasks at a very specific scope,
</li>
<li>but define them at the most general scope that makes sense,
</li>
<li>allowing tasks to be overridden in a blanket fashion, but at a
very fine grained level when required.
</li>
</ul>
</li>
</ul>
</li>
<li>sbt tasks execution are <b>paralleled by default</b>.
<ul class="org-ul">
<li>Two tasks that have no dependency on each other can, and will be
executed in parallel.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2">Declarative DSL</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>
<code>TaskKey</code>: is a string (the name) and a type (what the task produce).
<ul class="org-ul">
<li>
<code>sources</code> task has a name of ~"sources"~ and a type of <code>Seq[File]</code>
</li>
<li>Tasks key is uniquely defined by its <b>name</b>.
</li>
<li>Different Task keys with the same name but different type are not
allowed.
</li>
<li>
<code>SettingKey</code> is setting as in only executed once per session.
</li>
</ul>
</li>
<li>A <b>setting</b> as in a task declaration is
<ul class="org-ul">
<li>a <b>task or setting key</b>,
</li>
<li>potentially scoped,
</li>
<li>which some association behaviour.
</li>
</ul>
</li>
<li>Most of the settings are coming from sbt plugins.
<ul class="org-ul">
<li>
<code>JvmPlugin</code> plugin defines all the settings necessary for building
a Java or Scala program.
</li>
<li>Plugin settings are executed before the settings in your build
file.
</li>
<li>Any settings declare in your build file will override the settings
declared by the plugins.
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="previous">
                <a href="index-2.html" rel="prev">Newer posts</a>
            </li>
        </ul></nav>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents  2017         <a href="mailto:n.tesla@example.com">Warren Liu</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
